<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Integration Tests in RevBayes</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">Integration Tests in RevBayes</h1>
	
	<h4 class="authors"></h4>
  <h5>Last modified on March 13, 2020</h5>
</div>

<h2 class="section" id="introduction">Introduction</h2>
<hr class="section" />

<p>RevBayes is an extremely large and function rich software.
It is not possible to foresee if any code changes that you do might affect other functions.
This especially scares new developer who do not want to break existing code.
For this reason we have design a suite of so called <em>integration tests</em>.
In this document we will explain how these <em>integration tests</em> tests work in RevBayes.</p>

<p>The basic idea behind our integration tests is to used something closer to high level testing instead of unit testing.
That is, an integration test in RevBayes consists of a standard analysis, or even only reading in data and extracting information, and printing some output.
The output is then compared to the expected output using the common tool <strong>diff</strong>.
An integration test passes if the output exactly matches the expected output.</p>

<p>Hence, integration tests ensure that the software does not change (at least from a user perspective).
However, the integration test does not guarantee that the software works correctly.
You should always make sure that the implementation is correct, for example, by running some <a href="/developer/validation">validation using simulation-based calibration</a>.
Once you have established that the implementation is correct, you should use the integration tests to <strong>freeze</strong> the functionality which enforce that you can always rely on the code producing the output you expected at this time.
(Note, no test if perfect and sometimes changes to the functionality could be missed.)</p>

<p>Since MCMC analyses in RevBayes and other software are intrinsically stochastic, a naive approach would expect different output every singly time you run an analysis.
For example, if you run again an MCMC analysis in RevBayes, you should never get exactly the same trace of parameter samples.
Thus, to enable exactly predictable output, you have to specify the random number seed at the very beginning of your analysis.
In the end, all of our algorithms are deterministic given a sequence of random numbers ;)</p>

<h2 class="section" id="validation">Creating and Executing an <strong>Integration Test</strong></h2>
<hr class="section" />

<h3 class="subsection" id="dirstruct">Directory Structure</h3>
<hr class="subsection" />

<p>In the RevBayes GitHub repository, the validation scripts are all located within the folder called <a href="https://github.com/revbayes/revbayes/tree/master/tests">tests</a>.</p>

<figure id="fig_dir"><p><img src="figures/test_dir_structure.png" width="400" /></p>
<figcaption>The directory structure within RevBayes highlighting where the integration tests can be found. Note specifically the bash script <code class="language-plaintext highlighter-rouge">run_integration_tests.sh</code>.</figcaption>
</figure>

<p>Within the <strong>tests</strong> directory, there is one bash script call <code class="language-plaintext highlighter-rouge">run_integration_tests.sh</code>.
This is the bash script that runs <em>all</em> integration tests.
Additionally, there is a <strong>data</strong> directory where all the data needs to be stored.
You must not store data for your integration elsewhere.</p>

<p>Then, each integration test has its own directory which must start with <strong>test_</strong>.
If an integration test should excluded from the automatic testing, then simply prepend the directory with a <strong><em>**, for example, **_test_DEC_DA**.
Our bash script <code class="language-plaintext highlighter-rouge">run_integration_tests.sh</code> traverses the **tests** directory and searches for all subdirectories starting with **test</em></strong>.
Hence, if you add your new integration test by creating a new directory called, for example, <strong>test_my_first_test</strong>, then your new integration test if automatically included in our test suite.
So far not too difficult ;)</p>

<figure id="fig_dir_test"><p><img src="figures/integration_test_dir.png" width="600" /></p>
<figcaption>The directory structure within a specific integration tests. There should always be at least the two subdirectories called <strong>output_expected</strong> and <strong>scripts</strong>.</figcaption>
</figure>

<p>Next, within a specific integration test, you need to have at least two subdirectories:</p>
<ol>
  <li><strong>scripts</strong>: containing the <code class="language-plaintext highlighter-rouge">Rev</code> scripts one for each integration test analysis. There could be multiple files as long as each is its own analysis because we assume that each script can be run by itself.</li>
  <li><strong>output_expected</strong>: containing the expected output which basically is a copy of the output from your successful benchmark.</li>
</ol>

<h3 class="subsection" id="norma">Writing an integration test</h3>
<hr class="subsection" />

<p>Let us look at a simple integration test as an example.
Look at the file <a href="https://github.com/revbayes/revbayes/blob/master/test/test_BM/scripts/mcmc_BM.Rev">test/scripts/test_BM/scripts/mcmc_BM.Rev</a>.
This script will run a standard Brownian motion analysis for a single continuous trait evolving along a phylogeny.
The only estimated parameter here is the rate of evolution <code class="language-plaintext highlighter-rouge">sigma</code>.
The details of the model are not important because they will differ for your analysis.
In the end, an integration test a <em>almost</em> a standard analysis.</p>

<p>The main differences and important aspects to consider/follow are:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">seed(12345)</code>: We specify the seed of the random number generator at the very beginning of the script.</li>
  <li><strong>data</strong>: We always assume that your data is stored in the common data directory, so we can share the data among tests.</li>
  <li><strong>output</strong>: The results of the analysis will be stored in one or multiple files within the directory <strong>output</strong>. The is absolutely necessary because we run a <code class="language-plaintext highlighter-rouge">diff</code> on the directories <strong>output</strong> and <strong>output_expected</strong>.</li>
  <li><strong>printgen</strong>: often it makes sense to print every iteration. Here we are not interested in convergence but instead in the correct sequence of MCMC steps which only occurs if the likelihoods and MCMC moves are still working exactly the same way.</li>
  <li><strong>runtime</strong> Your integration test should not run longer than 5 seconds on your lousy laptop so that we can run hundreds of integration tests in less than 5 minutes. Therefore:
    <ul>
      <li>use a small toy dataset</li>
      <li>run the MCMC only for very few iterations</li>
      <li>use <code class="language-plaintext highlighter-rouge">moveschedule="single"</code> within the MCMC command to only use one move per generation.</li>
    </ul>
  </li>
</ul>

<h3 class="subsection" id="run">Running the integration tests locally</h3>
<hr class="subsection" />

<p>You can run the integration tests locally using (assuming your RevBayes GitHub directory is called <strong>revbayes</strong>)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd revbayes/tests
./run_integration_tests.sh "$PWD/../projects/cmake/rb"
</code></pre></div></div>
<p>This will run all the integration tests which can take a few minutes, but currently it should be less than 2 minutes.
At the end, you will receive the results as the output:</p>
<div class="language-plaintext Rev-output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#### Checking output from tests...
#### Test passed: BM
#### Test passed: BM_MVN
#### Test passed: BP
#### Test passed: CBDSP
#### Test passed: ChromoSSE
#### Test passed: Coal_const
#### Test passed: Coal_skyline
&gt;&gt;&gt;&gt; Test failed: DEC (expected)
	mismatch: mcmc_DEC.out
#### Test passed: EBD
&gt;&gt;&gt;&gt; Test failed: FBDP (expected)
	mismatch: mcmc_FBDP.out
	mismatch: mcmc_FBDP.trees
	mismatch: mcmc_FBDP_mcc.tre
#### Test passed: HSMRF_BDP
#### Test passed: JC_BDP
#### Test passed: JC_EBD
#### Test passed: JC_unrooted
#### Test passed: MVN_move
#### Test passed: OU
#### Test passed: Partition
#### Test passed: UCLD_noncentered
#### Test passed: basics
#### Test passed: multiple_mcmc
#### Test passed: mvBM
#### Test passed: skygrid
#### Test passed: steppingstone


#### Success! unexpected failures: 0   expected failures: 2   total tests: 23



#### All tests passed.
</code></pre></div></div>
<p>Yeah, all tests passed!</p>

<p>Try now write your own integration test!</p>

<h2 class="section" id="FAQ">Frequently Asked Questions</h2>
<hr class="section" />

<h3 class="subsection" id="MPI">The MPI version fails the test</h3>
<hr class="subsection" />

<p>Yes, the MPI version uses a different sequence of random numbers, and thus the expected output will look different.
We are currently working on a solution for this problem.</p>

<ol class="bibliography"></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>
      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
