<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Implementing a distribution</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
        <li><class="header-search">
  <form class="header-search-form" action="/search.html" method="get">
    <input type="text" id="search-box-nav" placeholder="Search..." name="query" style="border-color:black;background-color:white;height:32px;">
    <button type="submit" style="color:black; border-color:black;width:32px;height:32px;padding-top:4px">
        <img src="assets/img/search.png" height="22px" width="28px"/>
    </button>
  </form>
</div>

</li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">Implementing a distribution</h1>
	
	<h4 class="authors"></h4>
  <h5>Last modified on August 15, 2018</h5>
</div>

<h2 id="general-info-before-getting-started">General info before getting started</h2>

<ul>
  <li>
    <p>Within the RevBayes <strong>core</strong> directory, there are subdirectories for different categories of distributions. 
All mathematical distributions that have been implemented exist in <code class="language-plaintext highlighter-rouge">core/distributions/math</code>.</p>
  </li>
  <li>
    <p>Note that when implementing a new distribution, you will need to create <code class="language-plaintext highlighter-rouge">.cpp</code> and <code class="language-plaintext highlighter-rouge">.h</code> files in both the <strong>revlanguage</strong> directory and the <strong>core</strong> directory. (For a refresher on the difference between these two directories, refer to the <a href="/developer/architecture/">Getting familiar with the code</a> section of this Developer’s guide).
The overall naming format remains the same for every distribution in RevBayes. In the Beta Binomial Distribution example provided below, I specify what naming convention to use when creating each file.</p>
  </li>
  <li>
    <p>It is often helpful to look at/borrow code from existing RevBayes distributions for general help on syntax and organization.</p>
  </li>
</ul>

<p>For the language side, one of the most important things is the create distribution function (it converts user-arguments into calculations). Also, the getParameterRules function is important (to get the degrees of freedom &amp; other things). It is often helpful to look at the code of existing distributions for general help on syntax &amp; organization.</p>

<ul>
  <li>
    <p>Within every new distribution, you will need to include some functions. For example, each new distribution must have: the get class type, name, and help functions. You may not need to implement these from scratch (if they’re dictated by the parent class &amp; are already present), but you will need to implement other functions within your distribution (e.g. cdf, rv, quantile).</p>
  </li>
  <li>
    <p>Distributions have a prefix <code class="language-plaintext highlighter-rouge">DN</code> (dag node), and all moves have a prefix <code class="language-plaintext highlighter-rouge">MV</code>. RevBayes takes the name within &amp; creates the <code class="language-plaintext highlighter-rouge">DN</code> automatically, so be aware of this. For a refresher on DAG nodes, refer to <a href="/developer/architecture/">Getting familiar with the code</a>.</p>
  </li>
</ul>

<p>In the following steps, we’ll implement the <strong>Beta Binomial Distribution</strong> as an example, for syntax purposes.</p>

<h2 id="steps">Steps</h2>

<ol>
  <li>
    <p>Create new .cpp &amp; .h files in <code class="language-plaintext highlighter-rouge">revlanguage/distributions/math/</code>, named <code class="language-plaintext highlighter-rouge">Dist_betabinomial.cpp</code> and <code class="language-plaintext highlighter-rouge">Dist_betaBinomial.h</code>. 
<strong>Note:</strong> all files in this directory will follow this naming format: <code class="language-plaintext highlighter-rouge">Dist_&lt;nameofdistribution&gt;.[cpp|h]</code>.</p>

    <p>To populate these files, look at existing examples of similar distributions for specific info on what to include &amp; on proper syntax.  For example, for the Beta Binomial distribution, I checked the existing Binomial Distribution code for guidance.</p>

    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//add code here</span>
</code></pre></div>    </div>
  </li>
  <li>Test
    <ol>
      <li>
        <p>Create new <code class="language-plaintext highlighter-rouge">.cpp</code> &amp; <code class="language-plaintext highlighter-rouge">.h</code> files in <code class="language-plaintext highlighter-rouge">core/distributions/math/</code>, named <code class="language-plaintext highlighter-rouge">BetaBinomialDistribution.cpp</code> and <code class="language-plaintext highlighter-rouge">BetaBinomialDistribution.h</code>.</p>

        <p><strong>Note:</strong> This is the object oriented wrapper code that references the functions hard-coded in the next step. All files in this directory will follow this naming format: <code class="language-plaintext highlighter-rouge">&lt;NameOfDistribution&gt;Distribution.[cpp|h]</code>.</p>
      </li>
      <li>
        <p>Create new <code class="language-plaintext highlighter-rouge">.cpp</code> and <code class="language-plaintext highlighter-rouge">.h</code> files in <code class="language-plaintext highlighter-rouge">core/math/Distributions/</code>, named <code class="language-plaintext highlighter-rouge">DistributionBetaBinomial.cpp</code> and <code class="language-plaintext highlighter-rouge">DistributionBetaBinomial.h</code>.</p>

        <p>These are the raw procedural functions in the RevBayes namespace (e.g. pdf, cdf, quantile); they are not derived functions. <code class="language-plaintext highlighter-rouge">RbStatistics</code> is a namespace. To populate these files, look at existing examples of similar distributions to get an idea of what functions to include, what variables are needed, and the proper syntax.</p>

        <p><strong>Note:</strong> This is the most time-consuming step in the entire process of implementing a new distribution. All files in this directory will follow this naming format: <code class="language-plaintext highlighter-rouge">Distribution&lt;NameOfDistribution&gt;.[cpp|h]</code></p>
      </li>
    </ol>
  </li>
  <li>
    <p>Navigate to <code class="language-plaintext highlighter-rouge">revlanguage/workspace/RbRegister_Dist.cpp</code></p>

    <p><strong>Every</strong> new implementation must be registered in RevBayes. All register files are located in the <code class="language-plaintext highlighter-rouge">revlanguage/workspace</code> directory, and there are different files for the different types of implementations (<code class="language-plaintext highlighter-rouge">RbRegister_Func.cpp</code> is for registering functions; <code class="language-plaintext highlighter-rouge">RbRegister_Move</code> is for registering moves; etc.).  We are implementing a distribution, so we will edit the <code class="language-plaintext highlighter-rouge">RbRegister_Dist.cpp</code> file.</p>
  </li>
  <li>
    <p>You need to have an include statement at the top of the <code class="language-plaintext highlighter-rouge">RbRegister</code> script, to effectively add your distribution to the RevBayes language. You also need to add code to the bottom of this file, and give it a type and a <em>new</em> constructor. Generally, you can look within the file for an idea of proper syntax to use.</p>

    <p>For the Beta Binomial distribution, we navigate to the section in the file with the header ‘Distributions’ and then look for the sub-header dealing with ‘math distributions’. Then, add the following line of code:</p>

    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"Dist_betaBinomial.h"</span><span class="cp">
</span></code></pre></div>    </div>

    <p>This step registers the header file for the beta binomial distribution, effectively adding it to RevBayes.</p>

    <p>Next, navigate to the section of the file that initializes the global workspace. This section defines the workspace class, which houses info on all distributions. Then, add the following line of code:</p>

    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AddDistribution</span><span class="o">&lt;</span> <span class="n">Natural</span>		<span class="o">&gt;</span><span class="p">(</span> <span class="k">new</span> <span class="nf">Dist_betaBinomial</span><span class="p">());</span>
</code></pre></div>    </div>

    <p>This adds the distribution to the workspace. Without this step, the beta binomial distribution will not be added to the <code class="language-plaintext highlighter-rouge">revlanguage</code>.</p>

    <p><strong>Note:</strong> Depending on the kind of distribution, you may need to change <code class="language-plaintext highlighter-rouge">Natural</code> to a different type (e.g. <code class="language-plaintext highlighter-rouge">Probability</code>, <code class="language-plaintext highlighter-rouge">Real</code>, <code class="language-plaintext highlighter-rouge">RealPos</code>, etc.).</p>

    <p>After registering your distribution, you are ready to test your code.</p>
  </li>
  <li>
    <p>Before pushing your changes, you should ensure your code is working properly.</p>

    <p>There are multiple ways to do this. As a best practice, you should first compile it to ensure there are no errors. Once it compiles with no problems, you can test in various ways (e.g. run each individual function within the new Beta Binomial distribution in R, then run the Binomial distribution with a Beta prior in Rev and see if the output matches). For more information, see the developer tutorials on <a href="../validation/">validation</a> and testing. (TODO)</p>

    <p>After ensuring your code runs properly, you are ready to add it to the git repo. We recommend reading through the <a href="/developer/git-flow.html">RevBayes Git Workflow</a> section of the Developer’s guide before pushing.</p>
  </li>
</ol>

<ol class="bibliography"></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>
      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "default highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "default highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
