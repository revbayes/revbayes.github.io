<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Validation Scripts in RevBayes</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
        <li><class="header-search">
  <form class="header-search-form" action="/search.html" method="get">
    <input type="text" id="search-box-nav" placeholder="Search..." name="query" style="border-color:black;background-color:white;height:32px;">
    <button type="submit" style="color:black; border-color:black;width:32px;height:32px;padding-top:4px">
        <img src="assets/img/search.png" height="22px" width="28px"/>
    </button>
  </form>
</div>

</li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">Validation Scripts in RevBayes</h1>
	
	<h4 class="authors"></h4>
  <h5>Last modified on March 12, 2020</h5>
</div>

<h2 class="section" id="introduction">Introduction</h2>
<hr class="section" />

<p>We use a procedure that is called <em>Simulation-Based Calibration</em> (SBC) <a class="citation" href="#Talts2018">(Talts et al. 2018)</a> to test the implementation of our models (i.e., likelihood functions and parameter transformations) and MCMC algorithm (i.e., moves).
The idea behind SBC is using the frequentists properties of Bayesian inference.
That is, if we draw parameter values from their prior distributions and subsequently simulate data using these parameter values, the inferred XX % credible intervals (e.g., 90% CI) will contain the true (i.e., the simulated) parameter value in XX % of the repetitions (coverage probabilities; e.g., 90% of the simulations).</p>

<p>The last sentence was quite a mouthful.
Read it over and over again and try to fully understand it.
With some more words, the SBC algorithm/procedure works as follows:</p>
<ol>
  <li>Specify a full Bayesian model with at least one variable representing the parameter (or multiple parameter and hyperprior distributions) and at least one variable for the data.</li>
  <li>Specify the full MCMC procedure which would surely converge for such a tiny test scenario.</li>
  <li>Now run the SBC validation which:
  a Randomly draws parameter values (hierarchically) from the prior distribution.
  b Randomly draws observations (the data) given the parameter values.
  c Runs an MCMC analysis to estimate the posterior distribution of the parameters given the simulated data.
  d Checks if the true (i.e., simulated) parameters fall into the XX % credible interval (e.g., 90% CI).</li>
  <li>Repeat Step 3 many times, e.g., 1,000 or 10,000 times.</li>
  <li>Compute the frequency how often the true (i.e., simulated) parameter was covered in the XX % credible interval (e.g., 90% of the simulations).</li>
</ol>

<p>Now let’s work through an example to understand how to implement SBC in RevBayes.</p>

<h2 class="section" id="validation">Creating and Executing a Validation Script</h2>
<hr class="section" />

<h3 class="subsection" id="dirstruct">Directory Structure</h3>
<hr class="subsection" />

<p>Overview of an SBC analysis in RevBayes:</p>
<ol>
  <li>Create a <code class="language-plaintext highlighter-rouge">Rev</code> script for the validation analysis.</li>
  <li>Run the <code class="language-plaintext highlighter-rouge">Rev</code> script, e.g., <code class="language-plaintext highlighter-rouge">rb scripts/Validation_normal.Rev</code> or <code class="language-plaintext highlighter-rouge">mpirun -np 20 rb-mpi scripts/Validation_normal.Rev</code></li>
  <li>Check that you obtained acceptable coverage probabilities.</li>
</ol>

<h3 class="subsection" id="dirstruct">Directory Structure</h3>
<hr class="subsection" />

<p>In the RevBayes GitHub repository, the validation scripts are all located within the folder called <a href="https://github.com/revbayes/revbayes/tree/master/validation">validation</a>.</p>

<figure id="fig_dir"><p><img src="figures/validation_dir.png" width="500" /></p>
<figcaption>That directory structure within RevBayes. You should see the <code class="language-plaintext highlighter-rouge">validation</code> directory with the two sub-directories <code class="language-plaintext highlighter-rouge">scripts</code> and <code class="language-plaintext highlighter-rouge">data</code>.</figcaption>
</figure>

<p>In this directory there are two subdirectories:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">scripts</code>: containing the <code class="language-plaintext highlighter-rouge">Rev</code> scripts defining different models and analyses that use the RevBayes validation functions to evaluate the coverage of relevant parameters.</li>
  <li><code class="language-plaintext highlighter-rouge">data</code>: containing the data files used to determine the dimensions of the simulations for some
of the validation analyses (<em>e.g.</em>, taxon names, number of taxa, alignment length). Data files
are not necessary for validation of all models.</li>
</ol>

<h3 class="subsection" id="norma">Writing a Validation Script for the Normal Distribution</h3>
<hr class="subsection" />

<p>We can write a simple validation script that checks the performance of the <a href="https://github.com/revbayes/revbayes/blob/master/validation/scripts/Validation_normal.Rev">normal distribution</a>.
This script will check the coverage probabilities of estimators for parameters of the normal distribution.
The model we will use is shown in <a href="#fig_mod_gm"></a>.</p>

<figure id="fig_mod_gm"><p><img src="figures/model_gm.png" width="300" /></p>
<figcaption>A graphical model of describing the generation of $N$ samples, where $x_i \sim Normal(\mu,\sigma)$.
Additionally, priors are specified for the parameters of the normal distribution such that
$\mu \sim Uniform(-10,10)$ and $\sigma \sim Exponential(1)$. The validation tools will
assess the coverage probabilities for estimates of $\mu$ and $\sigma$.</figcaption>
</figure>

<p>The outcome of this validation will allow us to determine if the following things are
behaving correctly in RevBayes:</p>

<ul>
  <li>the functions for drawing random variates under the uniform, exponential, and normal distributions</li>
  <li>the calculation of the probability densities under each distribution</li>
  <li>the scale and slide moves</li>
  <li>and all of the machinery that puts these components together.</li>
</ul>

<p>The validation methods in RevBayes will take a model and set of moves, simulate true values for stochastic nodes and an observed data, estimate the values for the stochastic nodes conditioned on the simulated data, and compare whether the true values fall within a given credible interval (the default value is 90%) for each stochastic random variable.
This routine is performed for many simulation replicates (set in the validation script) and the coverage probability across replicates is summarized and reported to the screen.</p>

<p>The complete validation script for the Normal distribution can be found in the RevBayes GitHub repository:
<a href="https://github.com/revbayes/revbayes/blob/master/validation/scripts/Validation_normal.Rev"><code class="language-plaintext highlighter-rouge">Validation_normal.Rev</code></a>.
If you view this script, you will see that it begins with a header in comments that provide details about the script:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge"># RevBayes Validation Test: Normal Distribution</code> – the name of the validation test.</li>
  <li><code class="language-plaintext highlighter-rouge"># Model: 10 random variables from a normal distribution with a uniform prior on the mean and exponential prior on the standard deviation.</code> – a brief description of what the validation script is testing.</li>
  <li><code class="language-plaintext highlighter-rouge"># Inference: MCMC algorithm with the following moves: mvSlide and mvScale</code> – a list of moves that are tested in this validation</li>
  <li><code class="language-plaintext highlighter-rouge">authors: Sebastian Hoehna</code> – the author of the script and the person you should contact if you implement any new functionality in RevBayes that break their validation test.</li>
</ol>

<h4 class="subsubsection" id="model">Specify the model</h4>
<hr class="subsubsection" />

<p>The first part of the script specifies the model DAG (<em>i.e.</em>, random variables and conditional dependency) and its dimensions (<em>i.e.</em> the number of samples).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n_samples = 10

mu ~ dnUniform( -10, 10 )
sigma ~ dnExponential( 1.0 )

moves = VectorMoves()
moves.append( mvSlide(mu) )
moves.append( mvScale(sigma) )

for (i in 1:n_samples ) {
   x[i] ~ dnNormal(mu,sigma)
   x[i].clamp( 0.0 ) # clamping is actually not necessary but good practice
}
</code></pre></div></div>

<p>Note that in this script, the data node is clamped: <code class="language-plaintext highlighter-rouge">x[i].clamp( 0.0 )</code>.
This is not necessary since the validation methods will change the clamped value to the simulated data value for each simulation replicate.
It also doesn’t hurt to clamp the nodes in this case if you prefer to do so.
Clamping will make it more obvious which variables represent the data.</p>

<p>Once the model DAG is set up, you can create a model workspace variable:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymodel = model(mu)
</code></pre></div></div>

<h4 class="subsubsection" id="MCMC">Specify the MCMC object</h4>
<hr class="subsubsection" />

<p>Before using the validation functions, you need to first have an MCMC workspace variable.
Because the <code class="language-plaintext highlighter-rouge">mcmc()</code> function requires a list of monitors, we create an empty list to satisfy the required arguments of that function.
Ultimately, the validation functions will not actually use this monitor because a new ones
will be created for each simulation replicate.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors = VectorMonitors()
</code></pre></div></div>

<p>The MCMC object is initialized just like in any normal MCMC analysis.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc = mcmc(mymodel, monitors, moves)
</code></pre></div></div>

<h4 class="subsubsection" id="valid">Specify the validation analysis</h4>
<hr class="subsubsection" />

<p>The first step in specifying the validation analysis is to create a workspace object using
the <code class="language-plaintext highlighter-rouge">validationAnalysis()</code> function.
This function takes 2 arguments: (1) and MCMC object and (2) the number of
simulation replicates you want it to perform.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation = validationAnalysis( mymcmc, 1000 )
</code></pre></div></div>

<p>For this validation, note that we chose 1000 replicates.
For very large numbers of replicates, you will have a better approximation of the coverage probability.
However, there is a substantial trade-off when it comes to run-times.
Some of the validation scripts can take quite a long time to run.
Importantly, this can be alleviated if you compile the MPI version of RevBayes, which will run the individual replicates in parallel.</p>

<p>Next, you can specify a burn-in period, which will run the MCMC for each replicate for a specified number of MCMC cycles, while re-tuning the moves.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation.burnin(generations=10000,tuningInterval=100)
</code></pre></div></div>

<p>Now you can run the validation MCMC.
(As previously mentioned, it is best to compile the MPI version of RevBayes.)
The number of generations should be chosen at your discretion, but this should be a sufficient number of samplesso that you can ensure your MCMC has effectively sampled the target distribution.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation.run(generations=30000)
</code></pre></div></div>

<h4 class="subsubsection" id="summarize">Validation summary</h4>
<hr class="subsubsection" />

<p>Once the validation run is complete, you can use the <code class="language-plaintext highlighter-rouge">.summarize()</code> method of the validation object.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation.summarize( coverageProbability=0.9 )
</code></pre></div></div>

<div class="language-plaintext Rev-output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Summarizing analysis ...

The validation analysis ran 1000 simulations to validate the implementation.
This analysis used a 0.9 credible interval.
Coverage frequencies should be between 0.881 and 0.918 in 95% of the simulations.

Coverage frequencies of parameters in validation analysis:
==========================================================
mu                  		0.917
sigma               		0.882
</code></pre></div></div>

<p>At this point, you should conduct a visual inspection of the coverage frequencies for the parameters of your model.
Do the coverage frequencies fall within the interval calculated by the validation analysis to a reasonable degree?
In the example output above, the interval is 0.881 to 0.918.</p>

<h2 class="section" id="faq">Problems and Frequently Asked Questions</h2>
<hr class="section" />

<h3 class="subsection" id="my-coverage-probabilities-are-outside-the-expected-range-what-should-i-do">My coverage probabilities are outside the expected range, what should I do?</h3>
<hr class="subsection" />

<p>SBC is a stochastic procedure, so it can happen by chance that your coverage probabilities are outside the expected range.
You should run the SBC with more replicates and check if your coverage probabilities is now closer to the expected value.</p>

<p>If more replicates are not helping, then you should check your <code class="language-plaintext highlighter-rouge">Rev</code> script if everything is properly set-up, that you didn’t forget any MCMC moves by chance.
If you still get unexpected coverage probabilities, then you need to check:</p>
<ul>
  <li>the simulation function used in the distribution,</li>
  <li>the probability density function implemented for each distribution of your model, and</li>
  <li>the MCMC moves for your analysis (you could try to use different moves that are established).</li>
</ul>

<h3 class="subsection" id="i-got-a-segmentation-fault-when-summarizing-the-results">I got a segmentation fault when summarizing the results</h3>
<hr class="subsection" />

<p>This can happen when you run multiple SBC’s at the same time because they have hard-coded output files.
That means, your output might have been overwritten and does not match the analysis/model.
Make sure that the</p>

<ol class="bibliography"><li><span id="Talts2018">Talts S., Betancourt M., Simpson D., Vehtari A., Gelman A. 2018. Validating Bayesian inference algorithms with simulation-based calibration. arXiv preprint arXiv:1804.06788.</span>

</li></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>
      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
