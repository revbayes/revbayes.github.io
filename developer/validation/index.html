<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Setting up Validation Scripts in RevBayes</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/software">Software</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="https://revbayes.github.io/revscripter/">RevScripter</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">Setting up Validation Scripts in RevBayes</h1>
	
	<h4 class="authors"></h4>
  <h5>Last modified on August 15, 2018</h5>
</div>

<h2 class="section" id="introduction">Introduction</h2>
<hr class="section" />

<p>We use simulated datasets to validate that our models and methods are performing correctly.
In RevBayes, we have a specific way of doing this and the scripts for validation are contained
in the <a href="https://github.com/revbayes/revbayes">public repository</a>. This way if you implement a new 
move, distribution, function, etc., you can be certain that models and methods developed by other
members of the project are not affected and that your new method works.</p>

<h2 class="section" id="validation">Creating and Executing a Validation Script</h2>
<hr class="section" />

<h3 class="subsection" id="dirstruct">Directory Structure</h3>
<hr class="subsection" />

<p>In the RevBayes GitHub repository, the validation scripts are all located within the folder
called <a href="https://github.com/revbayes/revbayes/tree/master/validation"><code class="highlighter-rouge">validation</code></a>.
In this directory there are two subdirectories:</p>

<ol>
  <li><code class="highlighter-rouge">scripts</code>: containing the Rev scripts defining different models and analyses 
that use the RevBayes validation functions to evaluate the coverage of relevant parameters.</li>
  <li><code class="highlighter-rouge">data</code>: containing the data files used to determine the dimensions of the simulations for some 
of the validation analyses (<em>e.g.</em>, taxon names, number of taxa, alignment length). Data files
are not necessary for validation of all models.</li>
</ol>

<h3 class="subsection" id="norma">Writing a Validation Script for the Normal Distribution</h3>
<hr class="subsection" />

<p>We can write a simple validation script that checks the performance of the <a href="https://github.com/revbayes/revbayes/blob/master/validation/scripts/Validation_normal.Rev">normal distribution</a>. 
This script will check the coverage probabilities of estimators for parameters of the normal distribution.
The model we will use is shown in <a href="#fig_mod_gm"></a>.</p>

<figure id="fig_mod_gm"><p><img src="figures/model_gm.png" width="300" /></p>
<figcaption>A graphical model of describing the generation of $N$ samples, where $x_i \sim Normal(\mu,\sigma)$. 
Additionally, priors are specified for the parameters of the normal distribution such that
$\mu \sim Uniform(-10,10)$ and $\sigma \sim Exponential(1)$. The validation tools will 
assess the coverage probabilities for estimates of $\mu$ and $\sigma$.</figcaption>
</figure>

<p>The outcome of this validation will allow us to determine if the following things are 
behaving correctly in RevBayes:</p>

<ul>
  <li>the functions for drawing random variates under the uniform, exponential, and normal distributions</li>
  <li>the calculation of the probability densities under each distribution</li>
  <li>the scale and slide moves</li>
  <li>and all of the machinery that puts these components together.</li>
</ul>

<p>The validation methods in RevBayes will take a model and set of moves, simulate true values for stochastic nodes
and an observed data, 
estimate the values for the stochastic nodes conditioned on the simulated data, 
and compare whether the true values fall within a given credible
interval (the default value is 90%) for each stochastic random variable. 
This routine is performed for many simulation replicates 
(set in the validation script) and the coverage probability across replicates is summarized and 
reported to the screen.</p>

<p>The complete validation script for the Normal distribution can be found in the RevBayes GitHub
repository: 
<a href="https://github.com/revbayes/revbayes/blob/master/validation/scripts/Validation_normal.Rev"><code class="highlighter-rouge">Validation_normal.Rev</code></a>.
If you view this script, you will see that it begins with a header in comments that provide details about the script:</p>

<ol>
  <li><code class="highlighter-rouge"># RevBayes Validation Test: Normal Distribution</code> – the name of the validation test.</li>
  <li><code class="highlighter-rouge"># Model: Just a single random variable from a normal distribution.</code> – a brief description of what the validation script is testing.</li>
  <li><code class="highlighter-rouge">authors: Sebastian Hoehna</code> – the author of the script and the person you should contact if you implement any new functionality in RevBayes that break their validation test.</li>
</ol>

<h4 class="subsubsection" id="model">Specify the model</h4>
<hr class="subsubsection" />

<p>The first part of the script specifies the model DAG (<em>i.e.</em>, random variables and conditional dependency) and its dimensions (<em>i.e.</em> the number of samples).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n_samples = 10

mi = 0

mu ~ dnUniform( -10, 10 )
sigma ~ dnExponential( 1.0 )

moves[ ++mi ] = mvSlide( mu )
moves[ ++mi ] = mvScale( sigma )

for (i in 1:n_samples ) {
   x[i] ~ dnNormal(mu,sigma)
   x[i].clamp( 0.0 )
}
</code></pre></div></div>

<p>Note that in this script, the data node is clamped: <code class="highlighter-rouge">x[i].clamp( 0.0 )</code>. This is particularly necessary since 
the validation methods will change the clamped value to the simulated data value for each simulation replicate.
It also doesn’t hurt to clamp the nodes in this case if you prefer to do so.</p>

<p>Once the model DAG is set up, you can create a model workspace variable:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymodel = model(mu)
</code></pre></div></div>

<h4 class="subsubsection" id="MCMC">Specify the MCMC object</h4>
<hr class="subsubsection" />

<p>Before using the validation functions, you need to first have an MCMC workspace variable. Because the <code class="highlighter-rouge">mcmc()</code>
function requires a list of monitors, we must then create at least 1 monitor to satisfy the required arguments
of that function. Ultimately, the validation functions will not actually use this monitor because a new ones
will be created for each simulation replicate.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors[1] = mnModel(filename="output/normal_test.log",printgen=10, separator = TAB)
</code></pre></div></div>

<p>The MCMC object is initialized just like in any normal MCMC analysis.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc = mcmc(mymodel, monitors, moves)
</code></pre></div></div>

<h4 class="subsubsection" id="valid">Specify the validation analysis</h4>
<hr class="subsubsection" />

<p>The first step in specifying the validation analysis is to create a workspace object using 
the <code class="highlighter-rouge">validationAnalysis()</code> function. This function takes 2 argments: (1) and MCMC object and (2) the number of
simulation replicates you want it to perform.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation = validationAnalysis( mymcmc, 1000 )
</code></pre></div></div>

<p>For this validation, note that we chose 1000 replicates. For very large numbers of replicates, you will have a 
better approximation of the coverage probability. However, there is a substantial trade-off when it comes to 
run-times. Some of the validation scripts can take quite a long time to run. Importantly, this can be alleviated
if you compile the MPI version of RevBayes, which will run the individual replicates in parallel.</p>

<p>Next, you can specify a burn-in period, which will run the MCMC for each replicate for a specified number
of MCMC cycles, while re-tuning the moves.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation.burnin(generations=10000,tuningInterval=1000)
</code></pre></div></div>

<p>Now you can run the validation MCMC. (As previously mentioned, it is best to compile the MPI version of RevBayes.)
The number of generations should be chosen at your discretion, but this should be a sufficient number of samples
so that you can ensure your MCMC has effectively sampled the target distribution.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation.run(generations=30000)
</code></pre></div></div>

<h4 class="subsubsection" id="summarize">Validation summary</h4>
<hr class="subsubsection" />

<p>Once the validation run is complete, you can use the <code class="highlighter-rouge">.summarize()</code> method of the validation object.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validation.summarize()
</code></pre></div></div>

<div class="Rev-output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Summarizing analysis ...

The validation analysis ran 1000 simulations to validate the implementation.
This analysis used a 0.9 credible interval.
Coverage frequencies should be between 0.881 and 0.918 in 95% of the simulations.

Coverage frequencies of parameters in validation analysis:
==========================================================
mu                  		0.917
sigma               		0.882
</code></pre></div></div>

<p>At this point, you should conduct a visual inspection of the coverage frequencies for the parameters of your model. 
Do the coverage frequencies fall withing the interval calculated by the validation analysis to a reasonable degree? 
In the example output above, the interval is 0.881 to 0.918.</p>


<ol class="bibliography"></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>
      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>

<script src="/assets/js/base.js"></script>

<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
</script>

  </body>
</html>
