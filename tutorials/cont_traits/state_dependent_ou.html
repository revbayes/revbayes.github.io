<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: State-dependent Ornstein-Uhlenbeck Models</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
        <li><class="header-search">
  <form class="header-search-form" action="/search.html" method="get">
    <input type="text" id="search-box-nav" placeholder="Search..." name="query" style="border-color:black;background-color:white;height:32px;">
    <button type="submit" style="color:black; border-color:black;width:32px;height:32px;padding-top:4px">
        <img src="https://revbayes.github.io/assets/img/search.png" height="22px" width="28px"/>
    </button>
  </form>
</div>

</li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <!-- adds margin to main content -->
      <div class="container" style="padding-left:20px padding-right:20px;">
          <div class="titlebar">
	<h1 class="maintitle">State-dependent Ornstein-Uhlenbeck Models</h1>
	<h3 class="subtitle">Detecting adaptation to different discrete character states</h3>
	<h4 class="authors">Priscilla Lau and Sebastian Höhna</h4>
  <h5>Last modified on December  9, 2025</h5>
</div>


<div class="sidebar no-print">
<blockquote class="overview" id="overview">
  <h2>Overview</h2>
  
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul id="prerequisites">
          
            <li><a href="/tutorials/intro/">Getting Started with RevBayes and Rev Language Syntax</a></li>
          
            <li><a href="/tutorials/intro/revgadgets.html">Introduction to RevGadgets</a></li>
          
            <li><a href="/tutorials/mcmc/">Introduction to Markov chain Monte Carlo (MCMC) Sampling</a></li>
          
            <li><a href="/tutorials/cont_traits/cont_trait_intro.html">Introduction to Models of Continuous-Character Evolution</a></li>
          
            <li><a href="/tutorials/cont_traits/simple_ou.html">Simple Ornstein-Uhlenbeck Models</a></li>
          
            <li><a href="/tutorials/cont_traits/relaxed_ou.html">Relaxed Ornstein-Uhlenbeck Models</a></li>
          
          </ul>
        
    </div>
  </div>
  
</blockquote>





<blockquote class="tutorial_files" id="tutorial_files">
    <h2>Data files and scripts</h2>
    
        
        <strong>Other</strong>
        <ul id="other_files">
        
        
        
          <li><a href="/tutorials/cont_traits/data/artiodactyla.tree">artiodactyla.tree</a></li>
        
          <li><a href="/tutorials/cont_traits/data/artiodactyla_diet.nex">artiodactyla_diet.nex</a></li>
        
          <li><a href="/tutorials/cont_traits/data/artiodactyla_hypsodonty_index.nex">artiodactyla_hypsodonty_index.nex</a></li>
        
          <li><a href="/tutorials/cont_traits/scripts/mcmc_state_dependent_OU.Rev">mcmc_state_dependent_OU.Rev</a></li>
        
          <li><a href="/tutorials/cont_traits/scripts/plot_state_dependent_OU.R">plot_state_dependent_OU.R</a></li>
        
          <li><a href="/tutorials/cont_traits/scripts/plot_state_dependent_OU_helper.R">plot_state_dependent_OU_helper.R</a></li>
        
        </ul>
    
</blockquote>


</div>
<h2 class="section" id="inferring-adaptation-of-a-continuous-character-to-various-discrete-character-states">Inferring adaptation of a continuous character to various discrete character states</h2>
<hr class="section" />

<p>This tutorial demonstrates how to specify an Ornstein-Uhlenbeck model with state-dependent rates of attraction ($\alpha$), optima ($\theta$), and diffusion variances ($\sigma^2$) to model continuous-character adaptation to different discrete character states.
We provide two probabilistic graphical models for this tutorial, which correspond to sequential and joint inference approaches respectively.
After specifying the model, you will estimate the parameters of the state-dependent Ornstein-Uhlenbeck process for each character state.</p>

<h2 class="section" id="testing-hypotheses-of-state-dependent-adaptation-with-the-ou-model">Testing hypotheses of state-dependent adaptation with the OU Model</h2>
<hr class="section" />

<p>Previously, we used a relaxed OU model to infer adaptation of a continuous trait (in terms of optimum shifts) without specifying a potential cause (or correlated variable) for such adaptation.
However, we may be interested in testing specific hypotheses of continuous trait adaptation to different discrete character states.</p>

<p>In this tutorial, we will specify the state-dependent OU model described in <a class="citation" href="#Lau2026">Lau et al. In review</a>.
Under this model, any or all of the OU parameters ($\alpha$, $\theta$, $\sigma^2$) depend on the state of a discrete character that is also evolving on the phylogeny.
We must therefore specify a model that includes both the continuous trait and the discrete character.
Our state-dependent OU model implementation supports (1) sequential inference of OU parameters conditionally on a discrete character history and (2) joint inference of discrete character history and OU parameters.
Therefore, we will demonstrate how to (1) read in a character history (sequential inference approach), and (2) model discrete character evolution using a continuous-time Markov chain distribution (joint inference approach).</p>

<figure id="fig_ou_sd_gm"><p><img src="figures/state_dependent_ou_gm.png" width="50%" height="50%" /></p>
<figcaption>The graphical model representation of the state-dependent Ornstein-Uhlenbeck (OU) process using (a) a sequential inference approach and (b) a joint-inference approach. For more information about graphical model representations see <a class="citation" href="#Hoehna2014b">Höhna et al. (2014)</a>.</figcaption>
</figure>

<p>In this tutorial, we use a time-calibrated phylogeny, the hypsodonty index, and the diet of 82 ruminants (Artiodactyla) from { % citet toljagic2018 % } as data.</p>

<h3 class="subsection" id="read-the-data">Read the data</h3>
<hr class="subsection" />

<p>First, we read in the phylogenetic tree.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tree &lt;- readTrees("data/artiodactyla.tree")[1]
</code></pre></div></div>

<p>Next, we read in the discrete character data.
We have to exclude all other characters that we are not interested in and only include our focal character.
This can be done in RevBayes using the member methods <code class="language-plaintext highlighter-rouge">.excludeAll()</code> and <code class="language-plaintext highlighter-rouge">.includeCharacter()</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>disc &lt;- readDiscreteCharacterData("data/artiodactyla_diet.nex")
disc.excludeAll()
disc.includeCharacter( 1 ) # diet is the first (and only) character
num_disc_states &lt;- disc.getStateDescriptions().size()
</code></pre></div></div>

<p>Similarly, we read in the continuous trait data.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cont &lt;- readContinuousCharacterData("data/artiodactyla_hypsodonty_index.nex")
cont.excludeAll()
cont.includeCharacter( 1 ) # hypsodonty index is the first (and only) character
</code></pre></div></div>

<p>We initialize two vectors for moves and monitors respectively.
We initialize an adaptable variance multivariate normal (AVMVN) kernel to improve mixing of MCMC traces.
After specifying each parameter, we add the parameter to the kernel.
After all parameters are added, we add the kernel to the moves,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves    = VectorMoves()
monitors = VectorMonitors()
avmvn = mvAVMVN(weight=20, waitBeforeLearning=500, waitBeforeUsing=1000)
</code></pre></div></div>

<h3 class="subsection" id="discrete-character-history">Discrete character history</h3>
<hr class="subsection" />

<p>In a joint inference approach, we model the discrete character evolution using a continuous-time Markove chain distribution, which is defined by an instantaneous-rate matrix ($Q$).</p>

<p>Assuming all character states have equal transition rates, we specify an Mk model <a class="citation" href="#Lewis2001">(Lewis 2001)</a>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Q  &lt;- fnJC( num_disc_states )
</code></pre></div></div>

<p>We specify a scaling factor for the transition rates.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lambda ~ dnLognormal(ln(0.4), 0.05)
moves.append( mvScale(lambda, weight=1.0) )
avmvn_rates.addVariable(lambda)
</code></pre></div></div>

<p>Now, we specify a data augmentation-based CTMC model.
We use this CTMC model because the branch histories are sampled (instead of integrated out).
This allows us to retrieve instances of the character history, which will be used in the state-dependent OU model.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>X ~ dnPhyloCTMCDASiteIID(tree, Q, branchRates=lambda, type="Standard", nSites=1)
X.setValue(disc)
</code></pre></div></div>

<p>We include proposals for changing the character history at the nodes and on the branches.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvCharacterHistory(ctmc=X, qmap_site=Q, graph="node",   proposal="rejection", weight=400.0) )
moves.append( mvCharacterHistory(ctmc=X, qmap_site=Q, graph="branch", proposal="rejection", weight=100.0) )
</code></pre></div></div>

<p>We retrieve the character history from the CTMC model, which will be passed to the state-dependent OU model later.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>char_hist := X.characterHistories()
</code></pre></div></div>

<blockquote class="aside"><h2>Alternative: Sequential inference approach</h2><p>Alternatively, we can infer the character history in prior steps and read in the output as follows.
Note that the character history should be in simmap format.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>char_hist = readCharacterHistory("data/artiodactyla_character_history.tree")[1]
</code></pre></div></div>
</blockquote>

<h3 class="subsection" id="the-state-dependent-ou-model">The state-dependent OU model</h3>
<hr class="subsection" />

<p>Here, we set up a state-dependent OU model where all parameters are state-dependent.
The prior distributions we use below are empirically motivated.
First, we retrieve some information about the age of the tree and the among-species variance of the continuous trait data.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root_age &lt;- tree.rootAge()
across_species_variance &lt;- cont.var( 1 )
</code></pre></div></div>

<p>For the optimum parameter ($\theta$), we use a uniform distribution that covers more than the range of continuous trait observations.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (i in 1:num_disc_states){
  theta[i] ~ dnUniform(0, 10)
  moves.append(mvSlide(theta[i], weight = 1.0) )
  avmvn_cont.addVariable(theta[i])
}
</code></pre></div></div>

<p>There are two common ways to specify the rates of attraction ($\alpha$) and the diffusion variance ($\sigma^2$).
First, by putting priors directly on the parameters:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (i in 1:num_disc_states){

  a &lt;- ln(2) / root_age
  alpha[i] ~ dnLognormal(ln(a), 0.587405) # the median of the phylogenetic half-life is equal to one tree height
  moves.append(mvScale(alpha[i], weight = 1.0) )
  avmvn_cont.addVariable(alpha[i])
  
  s &lt;- across_species_variance * 2 * a
  sigma2[i] ~ dnLognormal(ln(s), 0.587405)
  moves.append(mvScale(sigma2[i], weight = 1.0) )
  avmvn_cont.addVariable(sigma2[i])
  
}
</code></pre></div></div>

<p>Alternatively, by putting hyper-priors on transformed parameters phylogenetic half-life ($t_{1/2}$) and stationary variance ($V_y$).
The advantage of using hyper-priors on transformed parameters is that these parameters have clear biological meaning and can be interpreted more easily (see { % citet Hansen1997 % }).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (i in 1:num_disc_states){

  t_half[i] ~ dnLognormal(ln(root_age), 0.587405)  # the median of the phylogenetic half-life is equal to one tree height
  moves.append(mvScale(t_half[i], weight = 1.0) )
  avmvn_cont.addVariable(t_half[i])
  
  alpha[i] := abs(ln(2)/t_half[i])

  Vy[i] ~ dnLognormal(ln(across_species_variance), 0.587405)  # the median of the stationary variance is equal to the across-species variance
  moves.append(mvScale(Vy[i], weight = 3.0) )
  avmvn_cont.addVariable(Vy[i])
  
  sigma2[i] := Vy[i] * 2 * alpha[i]
  
}
</code></pre></div></div>

<p>Finally, We add the AVMVN kernel to the moves.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( avmvn )
</code></pre></div></div>

<p>Now, we are ready to set up the state-dependent OU model.
We can choose between three possible root treatments, which is the assumption of the continuous trait value at the root.
Note that the option <code class="language-plaintext highlighter-rouge">parameter</code> should only be used when the phylogenetic tree contains fossil tips, which in our example does not.
Therefore, we choose the simplest option <code class="language-plaintext highlighter-rouge">optimum</code>, which assumes that the root value is the same as the optimum.
We assume that the discrete character states at the root is at stationary frequencies by not specifying the argument <code class="language-plaintext highlighter-rouge">rootFrequencies</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Y ~ dnPhyloOUSD(char_hist, theta=theta, rootTreatment="optimum", alpha=alpha, sigma=sigma2^0.5)
Y.clamp(cont)
</code></pre></div></div>

<p>We create a workspace object for the entire model with <code class="language-plaintext highlighter-rouge">model()</code>.
Remember that workspace objects are initialized with the <code class="language-plaintext highlighter-rouge">=</code> operator, and are not themselves part of the Bayesian graphical model.
The <code class="language-plaintext highlighter-rouge">model()</code> function traverses the entire model graph and finds all the nodes in the model that we specified.
This object provides a convenient way to refer to the whole model object, rather than just a single DAG node.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymodel = model(Y)
</code></pre></div></div>

<h3 class="subsection" id="running-an-mcmc-analysis">Running an MCMC analysis</h3>
<hr class="subsection" />

<h4 class="subsubsection" id="specify-monitors">Specify Monitors</h4>
<hr class="subsubsection" />

<p>For our MCMC analysis, we need to set up a vector of <em>monitors</em> to record the states of our Markov chain.
First, we will initialize the model monitor using the <code class="language-plaintext highlighter-rouge">mnModel</code> function.
This creates a new monitor variable that will output the states for all model parameters when passed into a MCMC function.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnModel(filename="output/trace.log", printgen=10) )
</code></pre></div></div>
<p>Additionally, create a screen monitor that will report the states of
specified variables to the screen with <code class="language-plaintext highlighter-rouge">mnScreen</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnScreen(printgen=1000, theta) )
</code></pre></div></div>
<p>Finally, we include a monitor for the character history.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnFile( char_hist, filename="output/character_histories.trees", printgen=10 ) )
</code></pre></div></div>

<h4 class="subsubsection" id="initialize-and-run-the-mcmc-simulation">Initialize and Run the MCMC Simulation</h4>
<hr class="subsubsection" />

<p>With a fully specified model, a set of monitors, and a set of moves, we
can now set up the MCMC algorithm that will sample parameter values in
proportion to their posterior probability. The <code class="language-plaintext highlighter-rouge">mcmc()</code> function will
create our MCMC object:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc = mcmc(mymodel, monitors, moves, nruns=2, combine="mixed")
</code></pre></div></div>
<p>Now, run the MCMC:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc.run(generations=50000, burnin=200)
</code></pre></div></div>

<p>Since the character history output is in simmap format, we will convert it to ancestral map format in R and summarize it in RevBayes.
Start R in the main directory for this analysis and then type the following commands:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span><span class="p">(</span><span class="s2">"scripts/plot_state_dependent_OU_helper.R"</span><span class="p">)</span><span class="w">

</span><span class="n">tree</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.tree</span><span class="p">(</span><span class="s2">"data/artiodactyla.tree"</span><span class="p">)</span><span class="w">
</span><span class="n">simmap_to_ancStates</span><span class="p">(</span><span class="s2">"output/character_histories.trees"</span><span class="p">,</span><span class="w"> </span><span class="s2">"output/character_histories.log"</span><span class="p">,</span><span class="w"> </span><span class="n">tree</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<p>Now, go back to RevBayes and type the following commands:</p>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file_in</span> <span class="o">&lt;-</span> <span class="s2">"output/character_histories.log"</span>
<span class="n">file_out</span> <span class="o">&lt;-</span> <span class="s2">"output/anc_states.tre"</span>

<span class="n">anc_states</span> <span class="o">=</span> <span class="n">readAncestralStateTrace</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
<span class="n">anc_tree</span> <span class="o">=</span> <span class="n">ancestralStateTree</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span>
                              <span class="n">ancestral_state_trace_vector</span><span class="o">=</span><span class="n">anc_states</span><span class="p">,</span>
                              <span class="n">include_start_states</span><span class="o">=</span><span class="kp">false</span><span class="p">,</span>
                              <span class="n">file</span><span class="o">=</span><span class="n">file_out</span><span class="p">,</span>
                              <span class="n">summary_statistic</span><span class="o">=</span><span class="s2">"MAP"</span><span class="p">,</span>
                              <span class="n">reconstruction</span><span class="o">=</span><span class="s2">"marginal"</span><span class="p">,</span>
                              <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                              <span class="n">nStates</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                              <span class="n">site</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">q</span><span class="p">()</span>
</code></pre></div></div>
<p>Note that <code class="language-plaintext highlighter-rouge">nStates</code> should always be &gt;= 3 even if your character is binary</p>

<p>Finally, open R again to plot the objects.
First, we plot the ancestral states at nodes.</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">cowplot</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RevGadgets</span><span class="p">)</span><span class="w">
</span><span class="n">source</span><span class="p">(</span><span class="s2">"scripts/plot_state_dependent_OU_helper.R"</span><span class="p">)</span><span class="w">

</span><span class="n">tree</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readTrees</span><span class="p">(</span><span class="s2">"data/artiodactyle.tree"</span><span class="p">)</span><span class="w">

</span><span class="c1"># plot the objects</span><span class="w">
</span><span class="n">ase</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">processAncStates</span><span class="p">(</span><span class="s2">"output/anc_states.tre"</span><span class="p">,</span><span class="w">
                        </span><span class="n">state_labels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"0"</span><span class="o">=</span><span class="s2">"Browsers"</span><span class="p">,</span><span class="w"> </span><span class="s2">"1"</span><span class="o">=</span><span class="s2">"Mixed feeders"</span><span class="p">,</span><span class="w"> </span><span class="s2">"2"</span><span class="o">=</span><span class="s2">"Grazers"</span><span class="p">))</span><span class="w">

</span><span class="n">p1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plotAncStatesMAP</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ase</span><span class="p">,</span><span class="w">
                       </span><span class="n">tip_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                       </span><span class="n">node_color_as</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"state"</span><span class="p">,</span><span class="w">
                       </span><span class="n">node_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Browsers"</span><span class="o">=</span><span class="s2">"#2c6e49"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mixed feeders"</span><span class="o">=</span><span class="s2">"#adc178"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Grazers"</span><span class="o">=</span><span class="s2">"#7f4f24"</span><span class="p">),</span><span class="w">
                       </span><span class="n">node_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w">
                       </span><span class="n">tip_states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                       </span><span class="n">tip_states_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w">
                       </span><span class="n">state_transparency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># modify legend location using ggplot2</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position.inside</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.6</span><span class="p">,</span><span class="m">0.8</span><span class="p">))</span><span class="w">

</span><span class="n">p2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plotAncStatesPie</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ase</span><span class="p">,</span><span class="w">
                       </span><span class="n">pie_colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Browsers"</span><span class="o">=</span><span class="s2">"#2c6e49"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mixed feeders"</span><span class="o">=</span><span class="s2">"#adc178"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Grazers"</span><span class="o">=</span><span class="s2">"#7f4f24"</span><span class="p">),</span><span class="w">   
                       </span><span class="n">node_pie_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w">
                       </span><span class="n">tip_pies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                       </span><span class="n">tip_pie_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w">
                       </span><span class="n">state_transparency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
                       </span><span class="n">tip_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">         
</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># modify legend location using ggplot2</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position.inside</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.6</span><span class="p">,</span><span class="m">0.8</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Then, we plot the branch histories with <em>maximumn a posteriori</em> probabilities.</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">char_hist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.table</span><span class="p">(</span><span class="s2">"output/sdou_joint/charhist.log"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">simmaps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.simmap</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">char_hist</span><span class="o">$</span><span class="n">char_hist</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"phylip"</span><span class="p">)</span><span class="w">
</span><span class="n">processed_simmaps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">processStochMaps</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span><span class="w"> </span><span class="n">simmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simmaps</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"0"</span><span class="p">,</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"2"</span><span class="p">))</span><span class="w">

</span><span class="n">colnames</span><span class="p">(</span><span class="n">processed_MAP</span><span class="p">)[</span><span class="m">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Browsers"</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">processed_MAP</span><span class="p">)[</span><span class="m">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Mixed feeders"</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">processed_MAP</span><span class="p">)[</span><span class="m">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Grazers"</span><span class="w">
  
</span><span class="n">p3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plotStochMaps</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span><span class="w"> </span><span class="n">maps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processed_MAP</span><span class="p">,</span><span class="w"> </span><span class="n">color_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MAP"</span><span class="p">,</span><span class="w">
                    </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Browsers"</span><span class="o">=</span><span class="s2">"#2c6e49"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mixed feeders"</span><span class="o">=</span><span class="s2">"#adc178"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Grazers"</span><span class="o">=</span><span class="s2">"#7f4f24"</span><span class="p">),</span><span class="w">
                    </span><span class="n">tip_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                    </span><span class="n">line_width</span><span class="o">=</span><span class="m">0.5</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1"># combine all maps</span><span class="w">
</span><span class="n">history_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_grid</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">p3</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Lastly, we plot the posterior probabilities of OU parameters.</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">trace</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readTrace</span><span class="p">(</span><span class="s2">"output/trace.log"</span><span class="p">,</span><span class="w"> </span><span class="n">burnin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span><span class="w">
</span><span class="n">color_diet</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#2c6e49"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#adc178"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#7f4f24"</span><span class="p">)</span><span class="w">

</span><span class="c1"># plot alpha</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">color_diet</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"alpha[1]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"alpha[2]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"alpha[3]"</span><span class="p">)</span><span class="w">
</span><span class="n">p4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plotTrace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"alpha[1]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"alpha[2]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"alpha[3]"</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color_diet</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Rate of attraction $alpha$"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"inverse time"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Posterior probability density"</span><span class="p">)</span><span class="w">

</span><span class="c1"># plot theta</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">color_diet</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"theta[1]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"theta[2]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"theta[3]"</span><span class="p">)</span><span class="w">
</span><span class="n">p5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plotTrace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"theta[1]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"theta[2]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"theta[3]"</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color_diet</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Optimum $theta$"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">,</span><span class="w">
        </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"hypsodonty index"</span><span class="p">)</span><span class="w">
</span><span class="c1"># plot sigma^2</span><span class="w">

</span><span class="nf">names</span><span class="p">(</span><span class="n">color_diet</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"sigma2[1]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"sigma2[2]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"sigma2[3]"</span><span class="p">)</span><span class="w">
</span><span class="n">p6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plotTrace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"sigma2[1]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"sigma2[2]"</span><span class="p">,</span><span class="w"> </span><span class="s2">"sigma2[3]"</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color_diet</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Diffusion variance"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"hypsodonty index-squared per unit time"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">,</span><span class="w">
        </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w">

</span><span class="c1"># plot legend</span><span class="w">
</span><span class="n">legend</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_legend2</span><span class="p">(</span><span class="n">p6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"left"</span><span class="p">,</span><span class="w">
                                 </span><span class="n">legend.box.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">margin</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span><span class="w">
                      </span><span class="o">+</span><span class="w"> </span><span class="n">guides</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guide_legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'Diet'</span><span class="p">),</span><span class="w">
                               </span><span class="n">fill</span><span class="o">=</span><span class="n">guide_legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">'Diet'</span><span class="p">))</span><span class="w">
                      </span><span class="o">+</span><span class="w"> </span><span class="n">scale_fill_discrete</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Diet"</span><span class="p">)</span><span class="w">
                      </span><span class="o">+</span><span class="w"> </span><span class="n">scale_color_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"#2c6e49"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#adc178"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#7f4f24"</span><span class="p">),</span><span class="w"> 
                                           </span><span class="n">name</span><span class="o">=</span><span class="s2">"Diet"</span><span class="p">,</span><span class="w">
                                           </span><span class="n">labels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Browsers"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mixed feeders"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Grazers"</span><span class="p">)))</span><span class="w">

</span><span class="n">ou_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_grid</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span><span class="w"> </span><span class="n">p5</span><span class="p">,</span><span class="w"> </span><span class="n">p6</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">4</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>Here we show the results of our example analysis.</p>

<figure id="fig_state_dependent_OU"><p><img src="figures/state_dependent_OU_history.png" width="50%" height="50%" />
<img src="figures/state_dependent_OU_pars.png" width="50%" height="50%" /></p>
<figcaption><strong>(Top) Estimated character history. (Bottom) Estimated state-dependent OU parameters.</strong></figcaption>
</figure>

<h3 class="subsection" id="exercise-1">Exercise 1</h3>
<hr class="subsection" />

<ul>
  <li>Modify the continuous-time Markove chain model by putting hyper-priors on the transformed parameters (note: $t_{1/2} = ln(2)/\alpha$, $V_y = \sigma^2 / 2\alpha$) and repeat the analysis.</li>
  <li>Are the priors put on $\alpha$ and $\sigma^2$ equivalent to the hyperpriors put on $t_{1/2}$ and $V_y$?</li>
</ul>

<h3 class="subsection" id="exercise-2">Exercise 2</h3>
<hr class="subsection" />

<ul>
  <li>Repeat the analysis with a sequential inference approach.</li>
  <li>Are the character history estimate and the OU parameter estimates same across the sequential and joint inference approaches?</li>
</ul>

<h3 class="subsection" id="exercise-3">Exercise 3</h3>
<hr class="subsection" />

<ul>
  <li>Modify the state-dependent OU model by specifying the root frequencies to be equal across all character states and repeat the analysis.</li>
  <li>How is the posterior probabilities of the character states at the root different than if we assume stationary frequencies at the root?</li>
</ul>


<ol class="bibliography"><li><span id="Hoehna2014b">Höhna S., Heath T.A., Boussau B., Landis M.J., Ronquist F., Huelsenbeck J.P. 2014. Probabilistic Graphical Model Representation in Phylogenetics. Systematic Biology. 63:753–771.</span>

<a href="https://doi.org/10.1093/sysbio/syu039">10.1093/sysbio/syu039</a>

</li>
<li><span id="Lau2026">Lau P., Kopperud B.T., Clarke J.T., Metzler D., Höhna S. In review. An efficient Bayesian phylogenetic approach for joint inference of continuous and discrete trait evolution under a state-dependent Ornstein–Uhlenbeck model. .</span>

</li>
<li><span id="Lewis2001">Lewis P.O. 2001. A Likelihood Approach to Estimating Phylogeny from Discrete Morphological Character Data. Systematic Biology. 50:913–925.</span>

<a href="https://doi.org/10.1080/106351501753462876">10.1080/106351501753462876</a>

</li></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>

      </div>
      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://github.com/revbayes/revbayes/discussions">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
