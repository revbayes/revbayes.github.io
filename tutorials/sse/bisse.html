<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: State-dependent diversification with BiSSE and MuSSE</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">State-dependent diversification with BiSSE and MuSSE</h1>
	<h3 class="subtitle">Inference using the binary/multiple state-dependent speciation and extinction (BiSSE/MuSSE) branching process</h3>
	<h4 class="authors">Sebastian Höhna, Will Freyman, and Emma Goldberg</h4>
  <h5>Last modified on March 11, 2022</h5>
</div>


<div class="sidebar no-print">
<blockquote class="overview" id="overview">
  <h2>Overview</h2>
  
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul id="prerequisites">
          
            <li><a href="/tutorials/intro/">Getting Started with RevBayes and Rev Language Syntax</a></li>
          
            <li><a href="/tutorials/mcmc/">Introduction to Markov chain Monte Carlo (MCMC) Sampling</a></li>
          
            <li><a href="/tutorials/divrate/simple.html">Simple Diversification Rate Estimation</a></li>
          
            <li><a href="/tutorials/sse/bisse-intro.html">Background on state-dependent diversification rate estimation</a></li>
          
          </ul>
        
    </div>
  </div>
  
</blockquote>





<blockquote class="tutorial_files" id="tutorial_files">
    <h2>Data files and scripts</h2>
    
        
        <strong>Data Files</strong>
        <ul id="data_files">
        
        
        
          <li><a href="/tutorials/morph_ase/data/primates_activity_period.nex">primates_activity_period.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_mating_system.nex">primates_mating_system.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_solitariness.nex">primates_solitariness.nex</a></li>
        
          <li><a href="/tutorials/biogeo/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/divrate/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_tree.nex">primates_tree.nex</a></li>
        
        </ul>
    
        
        <strong>Other</strong>
        <ul id="other_files">
        
        
        
          <li><a href="/tutorials/sse/scripts/mcmc_BiSSE.Rev">mcmc_BiSSE.Rev</a></li>
        
          <li><a href="/tutorials/sse/data/primates_activity_period.nex">primates_activity_period.nex</a></li>
        
          <li><a href="/tutorials/cont_traits/data/primates_activity_period.nex">primates_activity_period.nex</a></li>
        
          <li><a href="/tutorials/sse/data/primates_mating_system.nex">primates_mating_system.nex</a></li>
        
          <li><a href="/tutorials/cont_traits/data/primates_mating_system.nex">primates_mating_system.nex</a></li>
        
          <li><a href="/tutorials/cont_traits/data/primates_solitariness.nex">primates_solitariness.nex</a></li>
        
          <li><a href="/tutorials/sse/data/primates_solitariness.nex">primates_solitariness.nex</a></li>
        
          <li><a href="/tutorials/sse/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/intro/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/cont_traits/data/primates_tree.nex">primates_tree.nex</a></li>
        
        </ul>
    
</blockquote>


</div>
<h2 class="section" id="introduction">Introduction</h2>
<hr class="section" />

<p>This tutorial describes how to specify character state-dependent branching process models in RevBayes <a class="citation" href="#Hoehna2016b">(Höhna et al. 2016)</a>.
For more details on the theory behind these models, please see the introductory page: <a href="/tutorials/sse/bisse-intro.html">Background on state-dependent diversification rate estimation</a>.</p>

<p>This tutorial will explain how to fit the BiSSE and MuSSE models to data using Markov chain Monte Carlo (MCMC).
RevBayes is a powerful tool for SSE analyses:
to specify HiSSE model, please see <a href="/tutorials/sse/hisse.html">State-dependent diversification with HiSSE</a>,
for the ClaSSE model, please see <a href="/tutorials/sse/classe.html">State-dependent diversification with the ClaSSE model</a>
and for ChromoSSE please see <a href="/tutorials/chromo/">Chromosome Evolution</a>.</p>

<h2 class="section" id="thedata">Getting Set Up</h2>
<hr class="section" />

<p>We provide the data files which we will use in this tutorial:</p>

<ul>
  <li><a href="data/primates_tree.nex">primates_tree.nex</a>:
Dated primate phylogeny including 233 out of 367 species. This tree
is from <a class="citation" href="#MagnusonFord2012">Magnuson-Ford and Otto (2012)</a>, who took it from <a class="citation" href="#Vos2006">Vos and Mooers (2006)</a> and then
randomly resolved the polytomies using the method of <a class="citation" href="#Kuhn2011">Kuhn et al. (2011)</a>.</li>
  <li><a href="data/primates_activity_period.nex">primates_activity_period.nex</a>:
A file with the coded character states for primate species activity time. This character has just two states: <code class="language-plaintext highlighter-rouge">0</code> = diurnal and <code class="language-plaintext highlighter-rouge">1</code> = nocturnal.</li>
  <li><a href="data/primates_solitariness.nex">primates_solitariness.nex</a>:
A file with the coded character states for primate species social system type. This character has just two states: <code class="language-plaintext highlighter-rouge">0</code> = group living and <code class="language-plaintext highlighter-rouge">1</code> = solitary.</li>
  <li><a href="data/primates_mating_system.nex">primates_mating_system.nex</a>:
A file with the coded character states for primate species mating-system type. This character has four states: <code class="language-plaintext highlighter-rouge">0</code> = monogamy, <code class="language-plaintext highlighter-rouge">1</code> = polygyny, <code class="language-plaintext highlighter-rouge">2</code> = polygynandry, and <code class="language-plaintext highlighter-rouge">3</code> = polyandry.</li>
</ul>

<blockquote class="instruction">
  <p>Create a new directory on your computer called <code class="language-plaintext highlighter-rouge">RB_bisse_tutorial</code>.</p>

  <p>Within the <code class="language-plaintext highlighter-rouge">RB_bisse_tutorial</code> directory, create a subdirectory called <code class="language-plaintext highlighter-rouge">data</code>.
Then, download the provided files and place them in the <code class="language-plaintext highlighter-rouge">data</code> folder.</p>
</blockquote>

<h2 class="section" id="sec_CDBDP">Estimating State-Dependent Speciation and Extinction under the BiSSE Model</h2>
<hr class="section" />

<p>Now let’s start to analyze an example in RevBayes using the BiSSE
model. In RevBayes, it’s called <code class="language-plaintext highlighter-rouge">CDBDP</code>, meaning <em>character dependent
birth-death process</em>.</p>

<blockquote class="instruction">
  <p>Navigate to the <code class="language-plaintext highlighter-rouge">RB_bisse_tutorial</code> directory and execute the <code class="language-plaintext highlighter-rouge">rb</code> binary.
One option for doing this is to move the <code class="language-plaintext highlighter-rouge">rb</code> executable to the <code class="language-plaintext highlighter-rouge">RB_bisse_tutorial</code>
directory.</p>

  <p>Alternatively, if you are on a Unix system, and have added RevBayes to your path,
you simply have to type <code class="language-plaintext highlighter-rouge">rb</code> in your Terminal to run the program.</p>
</blockquote>

<p>For this tutorial, we will specify a BiSSE model that allows for speciation and extinction
to be correlated with a particular life-history trait: the timing of activity during the day.
If you open the file <a href="data/primates_activity_period.nex">primates_activity_period.nex</a>
in your text editor, you will see that several species like the mantled howler monkey
(<a href="https://en.wikipedia.org/wiki/Mantled_howler"><em>Alouatta palliata</em></a>) have the state <code class="language-plaintext highlighter-rouge">0</code>,
indicating that they are <em>diurnal</em>. Whereas other <em>nocturnal</em>
species, like the aye-aye
(<a href="https://en.wikipedia.org/wiki/Aye-aye"><em>Daubentonia madagascariensis</em></a>) are coded with <code class="language-plaintext highlighter-rouge">1</code>.
We may have an <em>a priori</em> hypothesis that diurnal species have higher rates of speciation and
by estimating the rates of lineages associated with that trait will allow us to explore this
hypothesis.</p>

<p>Once you execute RevBayes, you will be in the console. The rest of this tutorial will proceed
using the interactive console.</p>

<h3 class="subsection" id="subsec_readdata">Read in the Data</h3>
<hr class="subsection" />

<p>For this tutorial, we are assuming that the tree is “observed” and considered <em>data</em>.
Thus, we will read in the dated phylogeny first.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>observed_phylogeny &lt;- readTrees("data/primates_tree.nex")[1]
</code></pre></div></div>
<p>Next, we will read in the observed character states for primate activity period.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data &lt;- readCharacterData("data/primates_activity_period.nex")
</code></pre></div></div>
<p>It will be convenient to get the number of sampled
species <code class="language-plaintext highlighter-rouge">num_taxa</code> from the tree:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>num_taxa &lt;- observed_phylogeny.ntips()
</code></pre></div></div>
<p>Additionally, we initialize a variable for our vector of moves and monitors.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves    = VectorMoves()
monitors = VectorMonitors()
</code></pre></div></div>
<p>Finally, create a helper variable that specifies the number of states
that the observed character has:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NUM_STATES = 2
</code></pre></div></div>
<p>Using this variable allows us to easily change our script and use a different
character with a different number of states, essentially changing our
model from BiSSE <a class="citation" href="#Maddison2007">(Maddison et al. 2007)</a> to one that allows for more than 2 states–<em>i.e.</em>,
the MuSSE model <a class="citation" href="#FitzJohn2012">(FitzJohn 2012)</a>.</p>

<h3 class="subsection" id="subsec_specifymodel">Specify the Model</h3>
<hr class="subsection" />

<p>The basic idea behind the model in this example is that speciation and
extinction rates are dependent on a binary character, and the character
transitions between its two possible states <a class="citation" href="#Maddison2007">(Maddison et al. 2007)</a>.</p>

<h4 id="priors-on-the-rates"><strong>Priors on the Rates</strong></h4>

<p>We start by specifying prior distributions on the diversification rates.
Here, we will assume an identical prior distribution on each of the
speciation and extinction rates. Furthermore, we will use a log-uniform
distribution as the prior distribution on each speciation and
extinction rate (i.e., a uniform distribution on the log of the rates).</p>

<p>Now we can specify our character-specific speciation and extinction rate
parameters. Because we will use the same prior for each rate, it’s easy
to specify them all in a <code class="language-plaintext highlighter-rouge">for</code>-loop. We will use a log-uniform distribution as a prior
on the speciation and extinction rates. The loop also allows us to apply moves to each
of the rates we are estimating and create a vector of deterministic nodes
representing the rate of diversification ($\lambda - \mu$) associated with each
character state.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (i in 1:NUM_STATES) {

     ### Create a loguniform distributed variable for the diversification rate
    speciation[i] ~ dnLoguniform( 1E-6, 1E2)
    moves.append( mvScale(speciation[i],lambda=0.20,tune=true,weight=3.0) )

    ### Create a loguniform distributed variable for the turnover rate
    extinction[i] ~ dnLoguniform( 1E-6, 1E2)
    moves.append( mvScale(extinction[i],lambda=0.20,tune=true,weight=3.0) )


    diversification[i] := speciation[i] - extinction[i]

}
</code></pre></div></div>
<p>The stochastic nodes representing the vector of speciation rates and vector of
extinction rates have been instantiated. The software assumes that the rate in position <code class="language-plaintext highlighter-rouge">[1]</code> of each
vector corresponds to the rate associated with diurnal <code class="language-plaintext highlighter-rouge">0</code> lineages and the rate
at position <code class="language-plaintext highlighter-rouge">[2]</code> of each vector is the rate associated with nocturnal <code class="language-plaintext highlighter-rouge">1</code> lineages.</p>

<p>⇨ If RevBayes has trouble finding good starting values, then you can initialize the speciation and extinction rate as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speciation[i].setValue( ln(367.0/2.0) / observed_phylogeny.rootAge() )
extinction[i].setValue( speciation/10.0 )
</code></pre></div></div>

<p>You can print the current values of the speciation rate vector to your screen:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speciation
</code></pre></div></div>
<div class="language-plaintext Rev-output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ 0.267, 0.160 ]
</code></pre></div></div>

<p>Of course, your screen output will be different from the values shown above since your
stochastic nodes were initialized with different values drawn from the exponential prior.</p>

<p>Next we specify the transition rates between the states <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">1</code>:
$q_{01}$ and $q_{10}$. As a prior, we choose that each transition rate
is drawn from an exponential distribution with a mean of 10 character
state transitions over the entire tree. This is reasonable because we
use this kind of model for traits that transition not-infrequently, and
it leaves a fair bit of uncertainty.
Note that we will actually use a <code class="language-plaintext highlighter-rouge">for</code>-loop to instantiate the transition rates
so that our script will also work for non-binary characters.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rate_pr := observed_phylogeny.treeLength() / 10
for ( i in 1:(NUM_STATES*(NUM_STATES-1)) ) {
    transition_rates[i] ~ dnExp(rate_pr)
    moves.append( mvScale(transition_rates[i],lambda=0.20,tune=true,weight=3.0) )
}
</code></pre></div></div>
<p>Here, <code class="language-plaintext highlighter-rouge">rate[1]</code> is the rate of transition from state <code class="language-plaintext highlighter-rouge">0</code> (diurnal) to state <code class="language-plaintext highlighter-rouge">1</code> (nocturnal),
and <code class="language-plaintext highlighter-rouge">rate[2]</code> is the rate of going from nocturnal to diurnal.</p>

<p>Finally, we put the rates into a matrix, because this is what’s needed
by the function for the state-dependent birth-death process.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rate_matrix := fnFreeK( transition_rates, rescaled=false)
</code></pre></div></div>
<p>Note that we do not “rescale” the rate matrix. Rate matrices for
molecular evolution are rescaled to have an average rate of 1.0, but for
this model we want estimates of the transition rates with the same time
scale as the diversification rates.</p>

<h4 id="prior-on-the-root-state"><strong>Prior on the Root State</strong></h4>

<p>Create a variable for the root state frequencies. We are using a flat <a href="https://en.wikipedia.org/wiki/Dirichlet_distribution">Dirichlet distribution</a> as the prior on
each state. There has been some discussion about this in <a class="citation" href="#FitzJohn2009">(FitzJohn et al. 2009)</a>.
You could also fix the prior probabilities for the root states to be equal
(generally not recommended), or use empirical state frequencies.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root_state_freq ~ dnDirichlet( rep(1, NUM_STATES) )
</code></pre></div></div>
<p>Note that we use the <code class="language-plaintext highlighter-rouge">rep()</code> function which generates a vector of length <code class="language-plaintext highlighter-rouge">NUM_STATES</code>
with each position in the vector set to <code class="language-plaintext highlighter-rouge">1</code>. Using this function and the <code class="language-plaintext highlighter-rouge">NUM_STATES</code>
variable allows us to easily use this Rev script as a template for a different analysis
using a character with more than two states.</p>

<p>We will use a special move for objects that are drawn from a Dirichlet distribution:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>append( mvDirichletSimplex(rate_category_prior,tune=true,weight=2) )
</code></pre></div></div>

<h4 id="the-probability-of-sampling-an-extant-species"><strong>The Probability of Sampling an Extant Species</strong></h4>

<p>All birth-death processes are conditioned on the probability a taxon is sampled in the present.
We can get an approximation for this parameter by calculating the <em>proportion</em> of sampled
species in our analysis.</p>

<p>We know that we have sampled 233 out of 367 living described primate species. To
account for this we can set the sampling probability as a constant node
with a value of 233/367.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sampling &lt;- num_taxa / 367
</code></pre></div></div>

<h4 id="root-age"><strong>Root Age</strong></h4>

<p>The birth-death process also depends on time to the most-recent-common ancestor–<em>i.e.</em>,
the root. In this
exercise we use a fixed tree and thus we know the age of the tree.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root_age &lt;- T.rootAge()
</code></pre></div></div>

<h4 id="the-time-tree"><strong>The Time Tree</strong></h4>

<p>Now we have all of the parameters we need to specify the full character
state-dependent birth-death model. We initialize the stochastic node
representing the time tree and we create this node using the <code class="language-plaintext highlighter-rouge">dnCDBDP()</code> function.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timetree ~ dnCDBDP( rootAge           = root_age,
                    speciationRates   = speciation,
                    extinctionRates   = extinction,
                    Q                 = rate_matrix,
                    pi                = root_state_freq,
                    rho               = sampling )
</code></pre></div></div>
<p>Now, we will fix the BiSSE time-tree to the observed values from our data files. We use
the standard <code class="language-plaintext highlighter-rouge">.clamp()</code> method to give the observed tree and branch times:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timetree.clamp( observed_phylogeny )
</code></pre></div></div>
<p>And then we use the <code class="language-plaintext highlighter-rouge">.clampCharData()</code> to set the observed states at the tips of the tree:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timetree.clampCharData( data )
</code></pre></div></div>
<p>Finally, we create a workspace object of our whole model. The <code class="language-plaintext highlighter-rouge">model()</code>
function traverses all of the connections and finds all of the nodes we
specified.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymodel = model(timetree)
</code></pre></div></div>
<p>You can use the <code class="language-plaintext highlighter-rouge">.graph()</code> method of the model object to visualize the graphical model you
have just constructed . This function writes the model DAG to a file
that can be viewed using the  program <a href="https://www.graphviz.org/">Graphviz</a> (<a href="#graphviz"></a>).</p>

<figure id="graphviz"><p><img src="figures/bisse_dag.svg" width="95%" /></p>
<figcaption>The probabilistic graphical model of the character-state-dependent diversification model.
This image was generated by executing the <code class="language-plaintext highlighter-rouge">mymodel.graph("bisse.dot")</code> in RevBayes after specifying the full model DAG.
Then, the resulting file can be opened in the program <a href="https://www.graphviz.org/">Graphviz</a>.</figcaption>
</figure>

<h3 class="subsection" id="subsec_runningmcmc">Running an MCMC analysis</h3>
<hr class="subsection" />

<h4 id="specifying-monitors"><strong>Specifying Monitors</strong></h4>

<p>For our MCMC analysis, we set up a vector of <em>monitors</em> to record the
states of our Markov chain. The first monitor will model all numerical
variables; we are particularly interested in the rates of speciation,
extinction, and transition.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnModel(filename="output/primates_BiSSE_activity_period.log", printgen=1) )
</code></pre></div></div>
<p>Optionally, we can sample ancestral states during the MCMC analysis.
We need to add an additional monitor to record the state of each internal node in the tree.
The file produced by this monitor can be summarized so that we can visualize the estimates of ancestral states.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnJointConditionalAncestralState(tree=timetree,
                     cdbdp=timetree,  
                     type="Standard",
                     printgen=1,
                     withTips=true,
                     withStartStates=false,
                     filename="output/primates_BiSSE_activity_period_anc_states.log") )
</code></pre></div></div>
<p>Similarly, you may want to add a stochastic character map.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnStochasticCharacterMap(cdbdp=timetree,
                       filename="output/primates_BiSSE_activity_period_stoch_map.log",
                       printgen=1) )
</code></pre></div></div>
<p>Then, we add a screen monitor showing some updates during the MCMC
run.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnScreen(printgen=10, speciation, extinction) )
</code></pre></div></div>

<h4 id="initializing-and-running-the-mcmc-simulation"><strong>Initializing and Running the MCMC Simulation</strong></h4>

<p>With a fully specified model, a set of monitors, and a set of moves, we
can now set up the MCMC algorithm that will sample parameter values in
proportion to their posterior probability. The <code class="language-plaintext highlighter-rouge">mcmc()</code> function will
create our MCMC object:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc = mcmc(mymodel, monitors, moves, nruns=2, combine="mixed")
</code></pre></div></div>
<p>Now, run the MCMC:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc.run(generations=5000, tuningInterval=200)
</code></pre></div></div>

<h2 id="summarize-sampled-ancestral-states"><strong>Summarize Sampled Ancestral States</strong></h2>

<p>If we sampled ancestral states during the MCMC analysis, we can use the <code class="language-plaintext highlighter-rouge">RevGadgets</code> <a class="citation" href="#Tribble2022">(Tribble et al. 2022)</a> R package
to plot the ancestral state reconstruction.
First, though, we must summarize the sampled values in RevBayes.</p>

<p>To do this, we first have to read in the ancestral state log file. This uses a specific function called <code class="language-plaintext highlighter-rouge">readAncestralStateTrace()</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anc_states = readAncestralStateTrace("output/primates_BiSSE_activity_period_anc_states.log")
</code></pre></div></div>
<p>Now, we can write an annotated tree to a file. This function will write a tree with each
node labeled with the maximum a posteriori (MAP) state and the posterior probabilities for each
state.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anc_tree = ancestralStateTree(tree=T,
                  ancestral_state_trace_vector=anc_states,
                  include_start_states=false,
                  file="output/primates_BiSSE_anc_states_results.tree",
                  burnin=0,
                  summary_statistic="MAP",
                  site=1)
</code></pre></div></div>
<p>Similarly, we compute the maximum a posteriori (MAP) stochastic character map.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anc_state_trace = readAncestralStateTrace("output/primates_BiSSE_activity_period_stoch_map.log")
characterMapTree(observed_phylogeny,
                 anc_state_trace,
                 character_file="output/primates_BiSSE_activity_period_stoch_map_character.tree",
                 posterior_file="output/primates_BiSSE_activity_period_stoch_map_posterior.tree",
                 burnin=0.1,
                 reconstruction="marginal")
</code></pre></div></div>

<h3 class="subsection" id="subsec_ancviz">Visualize Estimated Ancestral States</h3>
<hr class="subsection" />

<p>To visualize the posterior probabilities of ancestral states, we will use the <code class="language-plaintext highlighter-rouge">RevGadgets</code> <a class="citation" href="#Tribble2022">(Tribble et al. 2022)</a> R package.</p>

<blockquote class="instruction">
  <p>Open R.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">RevGadgets</code> requires the <code class="language-plaintext highlighter-rouge">ggtree</code> package <a class="citation" href="#Yu2017ggtree">(Yu et al. 2017)</a>.
First, install the <code class="language-plaintext highlighter-rouge">ggtree</code> and <code class="language-plaintext highlighter-rouge">RevGadgets</code> packages:</p>

<pre>
install.packages("devtools")
library(devtools)
install_github("GuangchuangYu/ggtree")
install_github("revbayes/RevGadgets")
</pre>

<p>Run this code (or use the script <code class="language-plaintext highlighter-rouge">plot_anc_states_BiSSE.R</code>):</p>

<pre><code class="language-{R}">library(ggplot2)
library(RevGadgets)

# read in and process the ancestral states
bisse_file &lt;- paste0("output/primates_BiSSE_activity_period_anc_states_results.tree")
p_anc &lt;- processAncStates(bisse_file)

# plot the ancestral states
plot &lt;- plotAncStatesMAP(p_anc,
        tree_layout = "rect",
        tip_labels_size = 1) +
        # modify legend location using ggplot2
        theme(legend.position = c(0.1,0.85),
              legend.key.size = unit(0.3, 'cm'), #change legend key size
              legend.title = element_text(size=6), #change legend title font size
              legend.text = element_text(size=4))

ggsave(paste0("BiSSE_anc_states_activity_period.png"),plot, width=8, height=8)
</code></pre>

<figure id="BiSSE_anc_states"><p><img src="figures/BiSSE_anc_states_activity_period.png" width="75%" /></p>
<figcaption>A visualization of the ancestral states estimated under the BiSSE model. We used the script <code class="language-plaintext highlighter-rouge">plot_anc_states_BiSSE.R</code>.</figcaption>
</figure>

<p>Next, we also want to plot the stochastic character map.
Use the script <code class="language-plaintext highlighter-rouge">plot_simmap_BiSSE.R</code>.</p>

<figure id="BiSSE_simmap"><p><img src="figures/BiSSE_simmap_activity_period.png" width="75%" /></p>
<figcaption>A visualization of the stochastic character map estimated under the BiSSE model. We used the script <code class="language-plaintext highlighter-rouge">plot_simmap_BiSSE.R</code>.</figcaption>
</figure>

<h3 class="subsection" id="subsec_summary">Summarizing Parameter Estimates</h3>
<hr class="subsection" />

<p>Our MCMC analysis generated a tab-delimited file called <code class="language-plaintext highlighter-rouge">primates_BiSSE_activity_period.log</code> that contains
the samples of all the numerical parameters in our model.
Again, we will use the <code class="language-plaintext highlighter-rouge">RevGadgets</code> <a class="citation" href="#Tribble2022">(Tribble et al. 2022)</a> R package, which allow you to generate plots and
visually explore the posterior distributions of sampled parameters.</p>

<blockquote class="instruction">
  <p>Open R.</p>
</blockquote>

<p>Run this code:</p>
<pre><code class="language-{R}">library(RevGadgets)
library(ggplot2)

# read in and process the log file
bisse_file &lt;- paste0("output/primates_BiSSE_activity_period.log")
pdata &lt;- processSSE(bisse_file)

# plot the rates
plot &lt;- plotMuSSE(pdata) +
        theme(legend.position = c(0.875,0.915),
              legend.key.size = unit(0.4, 'cm'), #change legend key size
              legend.title = element_text(size=8), #change legend title font size
              legend.text = element_text(size=6))

ggsave(paste0("BiSSE_div_rates_activity_period.png"),plot, width=5, height=5)
</code></pre>

<figure id="BiSSE_rates"><p><img src="figures/BiSSE_div_rates_activity_period.png" width="95%" /></p>
<figcaption>Visualizing posterior samples of the speciation rates associated with daily activity time with the <code class="language-plaintext highlighter-rouge">RevGadgets</code> <a class="citation" href="#Tribble2022">(Tribble et al. 2022)</a> R package. We used the script <code class="language-plaintext highlighter-rouge">plot_div_rates_BiSSE.R</code>.</figcaption>
</figure>

<h2 class="section" id="exercise2">Evaluate Social System under the BiSSE Model</h2>
<hr class="section" />

<p>Now that you have completed the BiSSE analysis for the timing of activity for all primates,
perform the same analysis using a different character. Your <code class="language-plaintext highlighter-rouge">data</code> directory should
contain the file <a href="data/primates_solitariness.nex"><code class="language-plaintext highlighter-rouge">primates_solitariness.nex</code></a>, which has the
coded states for each species habitat type. This is also a <em>binary</em> character, where the states
are <code class="language-plaintext highlighter-rouge">0</code> = forest and <code class="language-plaintext highlighter-rouge">1</code> = savanna.</p>

<blockquote class="instruction">
  <p>Complete the BiSSE analysis for habitat type using the same commands given above.
Remember it is useful to <em>clear</em> the RevBayes console before starting another analysis. Do this
using the <code class="language-plaintext highlighter-rouge">clear()</code> function.</p>

  <p>While you are setting up your new analysis, substitute the character data file name so that you read in
<code class="language-plaintext highlighter-rouge">data/primates_solitariness.nex</code> instead of <code class="language-plaintext highlighter-rouge">primates_activity_period.nex</code>.</p>

  <p>It is <strong>important</strong> that you remember to also change the output file names.</p>

  <p>View the parameter log file in Tracer after your MCMC is complete.</p>

  <p>What is the rate of speciation associated with group living (<code class="language-plaintext highlighter-rouge">speciation[1]</code>)? What about
for solitary lineages (<code class="language-plaintext highlighter-rouge">speciation[2]</code>)?</p>
</blockquote>

<blockquote class="aside"><h2>Compare the rate estimates</h2><p>Compare the rates estimated when the activity time is the focal character versus when solitariness is the dependent character.
You can do this by opening <em>both</em> files in the same tracer window. If you managed to give all the parameters the same name,
it is possible to compare the estimates in the Tracer window by highlighting both files.</p>

<p>Explore the estimates of the various parameters. Are any different? Are any the same?</p>

<p>Why do you think you might be seeing this pattern?</p>
</blockquote>

<h2 class="section" id="exercise3">Evaluate Mating System under the MuSSE Model</h2>
<hr class="section" />

<p>In RevBayes it is trivial to change the BiSSE analysis you did in the exercises above to a multi-state model that is not limited to just
binary characters. That is because the model is effectively the same, just with the variable <code class="language-plaintext highlighter-rouge">NUM_STATES</code> changed.
For this final exercise, we will use the MuSSE model <a class="citation" href="#FitzJohn2012">(FitzJohn 2012)</a> to estimate the rates of speciation and extinction
associated with the mating system state for each primate lineage.</p>

<p>Your <code class="language-plaintext highlighter-rouge">data</code> directory should contain a file called <a href="/data/primates_mating_system.nex"><code class="language-plaintext highlighter-rouge">primates_mating_system.nex</code></a>. This is a four-state
character where the states are: <code class="language-plaintext highlighter-rouge">0</code> = monogamy, <code class="language-plaintext highlighter-rouge">1</code> = polygyny, <code class="language-plaintext highlighter-rouge">2</code> = polygynandry, and <code class="language-plaintext highlighter-rouge">3</code> = polyandry.</p>

<blockquote class="instruction">
  <p>Modify the analysis you completed for the binary state characters in the <a href="#sec_CDBDP">BiSSE Exercise</a> to accommodate a 4-state character.
This means that you must not only change the input data file (<code class="language-plaintext highlighter-rouge">primates_mating_system.nex</code>),
but you also need to specify <code class="language-plaintext highlighter-rouge">NUM_STATES = 4</code>. The <code class="language-plaintext highlighter-rouge">rate_matrix</code> must also be modified to accommodate 4 states.</p>

  <p>It is <strong>important</strong> that you remember to also change the output file names.</p>

  <p>View the parameter log file in Tracer after your MCMC is complete.</p>

  <p>What is the diversification rate associated with each state (<code class="language-plaintext highlighter-rouge">diversification</code>)?</p>
</blockquote>

<blockquote class="instruction">
  <p>Click below to begin the next exercise!</p>
</blockquote>

<ul>
  <li><a href="/tutorials/sse/hisse">Testing for state-dependent diversification with unobserved rate variation (HiSSE)</a></li>
</ul>

<ol class="bibliography"><li><span id="FitzJohn2009">FitzJohn R.G., Maddison W.P., Otto S.P. 2009. Estimating trait-dependent speciation and extinction rates from incompletely resolved phylogenies. Systematic Biology. 58:595–611.</span>

<a href="https://doi.org/10.1093/sysbio/syp067">10.1093/sysbio/syp067</a>

</li>
<li><span id="FitzJohn2012">FitzJohn R.G. 2012. Diversitree: Comparative Phylogenetic Analyses of Diversification in R. Methods in Ecology and Evolution. 3:1084–1092.</span>

<a href="https://doi.org/10.1111/j.2041-210X.2012.00234.x">10.1111/j.2041-210X.2012.00234.x</a>

</li>
<li><span id="Hoehna2016b">Höhna S., Landis M.J., Heath T.A., Boussau B., Lartillot N., Moore B.R., Huelsenbeck J.P., Ronquist F. 2016. RevBayes: Bayesian Phylogenetic Inference Using Graphical Models and an Interactive Model-Specification Language. Systematic Biology. 65:726–736.</span>

<a href="https://doi.org/10.1093/sysbio/syw021">10.1093/sysbio/syw021</a>

</li>
<li><span id="Kuhn2011">Kuhn T.S., Mooers A.Ø., Thomas G.H. 2011. A Simple Polytomy Resolver for Dated Phylogenies. Methods in Ecology and Evolution. 2:427–436.</span>

<a href="https://doi.org/10.1111/j.2041-210X.2011.00103.x">10.1111/j.2041-210X.2011.00103.x</a>

</li>
<li><span id="Maddison2007">Maddison W.P., Midford P.E., Otto S.P. 2007. Estimating a binary character’s effect on speciation and extinction. Systematic Biology. 56:701.</span>

<a href="https://doi.org/10.1080/10635150701607033">10.1080/10635150701607033</a>

</li>
<li><span id="MagnusonFord2012">Magnuson-Ford K., Otto S.P. 2012. Linking the Investigations of Character Evolution and Species Diversification. The American Naturalist. 180:225–245.</span>

<a href="https://doi.org/10.1086/666649">10.1086/666649</a>

</li>
<li><span id="Tribble2022">Tribble C.M., Freyman W.A., Landis M.J., Lim J.Y., Barido-Sottani J., Kopperud B.T., Höhna S., May M.R. 2022. RevGadgets: An R package for visualizing Bayesian phylogenetic analyses from RevBayes. Methods in Ecology and Evolution. 13:314–323.</span>

<a href="https://doi.org/https://doi.org/10.1111/2041-210X.13750">https://doi.org/10.1111/2041-210X.13750</a>

</li>
<li><span id="Vos2006">Vos R.A., Mooers A.Ø. 2006. A New Dated Supertree of the Primates. .</span>

</li>
<li><span id="Yu2017ggtree">Yu G., Smith D.K., Zhu H., Guan Y., Lam T.T.-Y. 2017. ggtree: an R package for visualization and annotation of phylogenetic trees with their covariates and other associated data. Methods in Ecology and Evolution. 8:28–36.</span>

</li></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>

      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
