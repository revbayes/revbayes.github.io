<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Environmental-dependent Speciation & Extinction Rates</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">Environmental-dependent Speciation & Extinction Rates</h1>
	<h3 class="subtitle">Estimating Correlation between Diversification Rates and Environmental Characters</h3>
	<h4 class="authors">Sebastian Höhna and Luis Palazzesi</h4>
  <h5>Last modified on March 10, 2022</h5>
</div>


<div class="sidebar no-print">
<blockquote class="overview" id="overview">
  <h2>Overview</h2>
  
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul id="prerequisites">
          
            <li><a href="/tutorials/intro/">Getting Started with RevBayes and Rev Language Syntax</a></li>
          
            <li><a href="/tutorials/mcmc/">Introduction to Markov chain Monte Carlo (MCMC) Sampling</a></li>
          
            <li><a href="/tutorials/divrate/simple.html">Simple Diversification Rate Estimation</a></li>
          
            <li><a href="/tutorials/divrate/ebd.html">Episodic Diversification Rate Estimation</a></li>
          
          </ul>
        
    </div>
  </div>
  
</blockquote>





<blockquote class="tutorial_files" id="tutorial_files">
    <h2>Data files and scripts</h2>
    
        
        <strong>Data Files</strong>
        <ul id="data_files">
        
        
        
          <li><a href="/tutorials/divrate/data/primates.tre">primates.tre</a></li>
        
          <li><a href="/tutorials/biogeo/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/divrate/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_tree.nex">primates_tree.nex</a></li>
        
        </ul>
    
        
        <strong>Scripts</strong>
        <ul id="scripts">
        
        
        
          <li><a href="/tutorials/divrate/scripts/mcmc_EBD_GMRF_env.Rev">mcmc_EBD_GMRF_env.Rev</a></li>
        
          <li><a href="/tutorials/divrate/scripts/mcmc_EBD_HSMRF_env.Rev">mcmc_EBD_HSMRF_env.Rev</a></li>
        
          <li><a href="/tutorials/divrate/scripts/mcmc_EBD_UC_env.Rev">mcmc_EBD_UC_env.Rev</a></li>
        
          <li><a href="/tutorials/divrate/scripts/mcmc_EBD_fixed_env.Rev">mcmc_EBD_fixed_env.Rev</a></li>
        
          <li><a href="/tutorials/divrate/scripts/plot_EBD_env.R">plot_EBD_env.R</a></li>
        
          <li><a href="/tutorials/divrate/scripts/plot_EBD_env_corr.R">plot_EBD_env_corr.R</a></li>
        
        </ul>
    
        
        <strong>Other</strong>
        <ul id="other_files">
        
        
        
          <li><a href="/tutorials/intro/data/primates.tre">primates.tre</a></li>
        
          <li><a href="/tutorials/cont_traits/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/intro/data/primates_tree.nex">primates_tree.nex</a></li>
        
          <li><a href="/tutorials/sse/data/primates_tree.nex">primates_tree.nex</a></li>
        
        </ul>
    
</blockquote>


</div>
<h2 class="section" id="overview">Overview</h2>
<hr class="section" />

<p>This tutorial describes how to specify a branching-process model with
diversification rate correlated with an environmental variable in <code class="language-plaintext highlighter-rouge">RevBayes</code> <a class="citation" href="#Hoehna2016b">(Höhna et al. 2016)</a>.
Diversification rates are assumed to be equal among all lineages but vary through time correlated with an environmental predictor variable <a class="citation" href="#Condamine2013">(Condamine et al. 2013; Condamine et al. 2018; Palazzesi et al. 2022)</a>.
Thus, this model can be used to test for correlations between diversification rates
and environmental variables, such as $\text{CO}_2$ and temperature.
However, these tests are only to establish a correlation, not to establish causality.</p>

<p>As usual, we provide the probabilistic graphical model at the beginning of this tutorial.
Hopefully this will help you to get a better idea of all the variables in the model and their dependencies.
Our goal in this tutorial is to estimate the correlation coefficient between speciation and extinction rates to historical $\text{CO}_2$ measurements using Markov chain Monte Carlo (MCMC).</p>

<h2 class="section" id="environmental-dependent-diversification-rate-models">Environmental-dependent Diversification Rate Models</h2>
<hr class="section" />

<p>The fundamental idea of this model is the question if diversification rates are correlated with an environmental variable.
Examples of environmental variables are $\text{CO}_2$ and temperature.</p>
<figure id="fig_CO2"><p><img src="figures/Historical_CO2.png" width="75%" height="75%" /></p>
<figcaption>Estimates of historical $\text{CO}_2$ values. These estimates are obtained from <a class="citation" href="#Beerling2011">Beerling and Royer (2011)</a>.</figcaption>
</figure>
<p>Have a look at <a href="#fig_CO2"></a> which shows the historical value $\text{CO}_2$ in the last 50 million years.
We can clearly see that the $\text{CO}_2$ dropped drastically around 30 million years ago.</p>

<figure id="fig_EBD_estimates"><p><img src="figures/EBD_10_Result.png" width="75%" height="75%" /></p>
<figcaption>Estimated diversification rates through time. These estimates are taken from the episodic birth-death model with autocorrelated (Brownian motion) rate as described in the <a href="/tutorials/divrate/ebd.html">Episodic Diversification Rate Estimation</a>.</figcaption>
</figure>
<p>In our previous <a href="/tutorials/divrate/ebd.html">Episodic Diversification Rate Estimation</a> we estimated diversification as shown in <a href="#fig_EBD_estimates"></a>.
We clearly see that diversification rates were not constant through time.
Now we wonder if perhaps the diversification rates are correlated with $\text{CO}_2$.</p>

<p>We want to build on our episodic birth-death model so that our environmental correlation model collapses to the episodic birth-death model if there is no correlation.
Recall that we used a Brownian motion model on the log-transformed rates.
Hence, we assumed that the rates in the next time interval (epoch) have the current value as their expectation:</p>

\[E[\log( \lambda(t) )] = \log( \lambda(t-\Delta t) )\]

<p>For the environmental dependent birth-death model, we have additional observation from the environmental variable.
Thus, we know how much the environmental variable changed between time intervals (epochs).
We can compute this change by taking the ratio between two consecutive measurements:
$\frac{\text{CO}_2(t)}{\text{CO}_2(t-\Delta t)}$.
Hence, if the $\text{CO}_2$ double from one epoch to the next we would compute a change of 2.
This has the clear advantage that our computation is less sensitive to the unit and magnitude of the environmental variable.</p>

<p>Now let us assume that our diversification rates shift synchronously with the environmental variable if they are actually correlated.
Then we can express our expectation of the log-transformed diversification rate in the next time interval (epoch) as being equal the log-transform diversification rate in the current time interval plus the log-transformed change in the environmental variable:</p>

\[E[\log( \lambda(t) )] = \log( \lambda(t-\Delta t) ) + \beta \times \log\left( \frac{\text{CO}_2(t)}{\text{CO}_2(t-\Delta t)} \right) \mbox{ .}\]

<p>Here we denote the correlation coefficient by $\beta$.
If $\beta &gt; 0$ then there is a positive correlation between the speciation rate and $\text{CO}_2$, that is, if the $\text{CO}_2$ increases then the speciation increases also.
If $\beta &lt; 0$ then there is a negative correlation between the speciation rate and $\text{CO}_2$, that is, if the $\text{CO}_2$ increases then the speciation decreases.
Finally, if $\beta = 0$ then there is no correlation and our model collapses to the episodic birth-death model.</p>

<p>In summary, we use a regression-like prior model for the speciation and extinction rate where the environmental variable (here $\text{CO}_2$) is the predictor variable.
Specifically, we use a Brownian motion model for the log-transformed speciation and extinction rates where the expectation depends on the shift in the environmental variable.
Thus, our model can be considered as a Brownian motion model with drift where the drift parameter is the environmental variable.</p>

<p>We will now walk you through setting up this analysis in <code class="language-plaintext highlighter-rouge">RevBayes</code>.</p>

<h2 class="section" id="estimating-environment-dependent-diversification-rates">Estimating Environment-dependent Diversification Rates</h2>
<hr class="section" />

<h3 class="subsection" id="read-the-tree">Read the tree</h3>
<hr class="subsection" />

<p>Begin by reading in the “observed” tree.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>T &lt;- readTrees("data/primates_tree.nex")[1]
</code></pre></div></div>

<p>From this tree, we get some helpful variables, such as the taxon information which we need to instantiate the birth-death process.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>taxa &lt;- T.taxa()
</code></pre></div></div>

<p>Additionally, we can initialize a variable for our vector of
moves and monitors:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves    = VectorMoves()
monitors = VectorMonitors()
</code></pre></div></div>

<h3 class="subsection" id="set-up-the-environmental-data">Set up the environmental data</h3>
<hr class="subsection" />

<p>We take the $\text{CO}_2$ measurement from <a class="citation" href="#Beerling2011">Beerling and Royer (2011)</a> (see also <a class="citation" href="#Palazzesi2022">Palazzesi et al. (2022)</a>) and store the values on a vector; one measurement (value) per interval.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var &lt;- v(297.6, 301.36, 304.84, 307.86, 310.36, 312.53, 314.48, 316.31, 317.42, 317.63, 317.74, 318.51, 318.29, 316.5, 315.49, 317.64, 318.61, 316.6, 317.77, 328.27, 351.12, 381.87, 415.47, 446.86, 478.31, 513.77, 550.74, 586.68, 631.48, 684.13, 725.83, 757.81, 789.39, 813.79, 824.25, 812.6, 784.79, 755.25, 738.41, 727.53, 710.48, 693.55, 683.04, 683.99, 690.93, 694.44, 701.62, 718.05, 731.95, 731.56, 717.76)
</code></pre></div></div>
<p>Then we specify the maximum age of the measurements.
This corresponds to the time of the last interval.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MAX_VAR_AGE = 50
</code></pre></div></div>
<p>We will later use this maximum age to compute the times for each interval by assuming that each interval is equal in time.</p>

<p>Finally, we create a helper variable that specifies the number of intervals.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NUM_INTERVALS = var.size()-1
</code></pre></div></div>
<p>This variable will help us to create the episodic diversification rate using a <code class="language-plaintext highlighter-rouge">for-loop</code>.</p>

<h4 class="subsubsection" id="setting-up-the-time-intervals">Setting up the time intervals</h4>
<hr class="subsubsection" />

<p>In <code class="language-plaintext highlighter-rouge">RevBayes</code> you actually have the possibility to specify unequal time intervals or even different intervals for the speciation and extinction rate.
This is achieved by providing a vector of times when each interval ends.
However, here we assume for simplicity that each interval has the same length because this is how we obtained our environmental data.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interval_times &lt;- MAX_VAR_AGE * (1:NUM_INTERVALS) / NUM_INTERVALS
</code></pre></div></div>
<p>This vector of times will be used for both the speciation and extinction rates.
Also, remember that the times of the intervals represent ages going backwards in time.</p>

<h3 class="subsection" id="specifying-the-model">Specifying the model</h3>
<hr class="subsection" />

<h4 class="subsubsection" id="priors-on-amount-of-rate-variation">Priors on amount of rate variation</h4>
<hr class="subsubsection" />

<p>We follow here exactly the prior specification as in the <a href="/tutorials/divrate/ebd.html">Episodic Diversification Rate Estimation</a> tutorial because we want our model to collapse to the episodic birth-death if there is no correlation.</p>

<p>We start by specifying prior distributions on the rates.
Each interval-specific speciation and extinction rate will be drawn from a normal distribution.
Thus, we need a parameter for the standard deviation of those normal distributions.
We use an exponential hyperprior with rate <code class="language-plaintext highlighter-rouge">SD = 0.587405 / NUM_INTERVALS</code> to estimate the standard deviation, but assume that all speciation rates and all extinction rates share the same standard deviation.
The motivation for an exponential hyperprior is that it has the highest probability density at 0 which would make the variance of rates between consecutive time intervals 0 and thus represent a constant rate process.
The data will tell us if there should be much variation in rates through time.
(You may want to experiment with this hyperprior if you are interested.)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SD = abs(0.587405 / NUM_INTERVALS)

speciation_sd ~ dnExponential( 1.0 / SD)
extinction_sd ~ dnExponential( 1.0 / SD)
</code></pre></div></div>
<p>We apply a simple scaling move on each prior parameter.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvScale(speciation_sd, weight=5.0) )
moves.append( mvScale(extinction_sd, weight=5.0) )
</code></pre></div></div>

<h4 class="subsubsection" id="specifying-the-correlation-coefficients">Specifying the correlation coefficients</h4>
<hr class="subsubsection" />

<p>Then we specify normal prior distributions on the correlation coefficient $\beta$ for the speciation and extinction rate.
Again, out total lack of prior knowledge, we will assume that the standard deviation of $\beta$ is $1.0$ and you may want to modify this value.
Nevertheless, this normal prior distribution is motivated by being centered at 0.0 (no correlation) and gives equal weight to positive and negative correlations.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beta_speciation ~ dnNormal(0,1.0)
beta_extinction ~ dnNormal(0,1.0)
</code></pre></div></div>
<p>We apply simple sliding-window moves for the two correlation coefficients because they are defined on the whole real line.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvSlide(beta_speciation,delta=1.0,weight=10.0) )
moves.append( mvSlide(beta_extinction,delta=1.0,weight=10.0) )
</code></pre></div></div>
<p>Additionally, we might be interested in the posterior probability that there is a positive correlation, $\mathbb{P}(\beta&gt;0)$, or a negative correlation, $\mathbb{P}(\beta&lt;0)$, respectively.
We achieve this using a deterministic variable that is 1 if $\beta&lt;0$</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speciation_corr_neg_prob := ifelse(beta_speciation &lt; 0.0, 1, 0)
extinction_corr_neg_prob := ifelse(beta_extinction &lt; 0.0, 1, 0)
speciation_corr_pos_prob := ifelse(beta_speciation &gt; 0.0, 1, 0)
extinction_corr_pos_prob := ifelse(beta_extinction &gt; 0.0, 1, 0)
</code></pre></div></div>
<p>Note that in this model the probability of $\beta$ being 0.0 ($\mathbb{P}(\beta=0)=0$)
because we are working with a prior and posterior <em>density</em> on $\beta$ and thus any specific value,
<em>e.g.,</em> 0.0, has a probability of 0.0.
We will circumvent this issue in the next chapter when we use reversible-jump MCMC to set $\beta$ specifically to 0.0.
Here you can also check that the posterior probability of <code class="language-plaintext highlighter-rouge">speciation_corr_pos_prob</code> equals <code class="language-plaintext highlighter-rouge">1-speciation_corr_neg_prob</code>.</p>

<h4 class="subsubsection" id="specifying-correlated-rates">Specifying correlated rates</h4>
<hr class="subsubsection" />

<p>As we mentioned before, we will apply normal distributions as priors for each log-transformed rate.
We begin with the rate at the present which is our initial rate parameter.
The rates at the present will be specified slightly differently because they are not correlated to any previous rates.
This is because we are actually modeling rate-changes backwards in time and there is no previous rate for the rate at the present.</p>

<p>We use a uniform distribution between -10 and 10 because of our lack of prior knowledge on the diversification rate.
This actually means that we allow speciation and extinction rates between $e^{-10}$ and $e^{10}$ we should clearly cover the true values.
(Note that for diversification rate estimates $e^{-10}$ is virtually 0 since the rate is so slow).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>log_speciation[1] ~ dnUniform(-10.0,10.0)
log_speciation[1].setValue(0.0)
log_extinction[1] ~ dnUniform(-10.0,10.0)
log_extinction[1].setValue(-1.0)
</code></pre></div></div>
<p>Notice that we store the diversification rate variables in vectors.
Storing the rate parameters in vectors will be useful and important later when we pass the rates into the birth-death process.</p>

<p>We apply simple sliding window moves for the rates.
Normally we would use scaling moves but in this case we work on the log-transformed parameters and thus sliding moves perform better.
(If you are keen you can test the differences.)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvSlide(log_speciation[1], weight=2) )
moves.append( mvSlide(log_extinction[1], weight=2) )
</code></pre></div></div>
<p>Now we transform the diversification rate parameters into actual rates.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speciation[1] := exp( log_speciation[1] )
extinction[1] := exp( log_extinction[1] )
</code></pre></div></div>

<p>Next, we specify the speciation and extinction rates for each time interval (<em>i.e.</em>, epoch).
This can be done efficiently using a <code class="language-plaintext highlighter-rouge">for-loop</code>.
We will use a specific index variable so that we can easier refer to the rate at the previous interval.
Remember that we want to model the rates as a Brownian motion,
which we achieve by specify a normal distribution as the prior distribution on the rates centered around the previous rate plus the change in the environmental variable
(<em>i.e.,</em> the mean is equal to the previous rate plus the log-transformed ratio of the environmental variable divided by the previous value).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (i in 1:NUM_INTERVALS) {
    index = i+1

    expected_speciation[i] := log_speciation[i] + beta_speciation * ln( var[index] / var[i] )
    expected_extinction[i] := log_extinction[i] + beta_extinction * ln( var[index] / var[i] )

    log_speciation[index] ~ dnNormal( mean=expected_speciation[i], sd=speciation_sd )
    log_extinction[index] ~ dnNormal( mean=expected_extinction[i], sd=extinction_sd )

    moves.append( mvSlide(log_speciation[index], weight=2) )
    moves.append( mvSlide(log_extinction[index], weight=2) )

    speciation[index] := exp( log_speciation[index] )
    extinction[index] := exp( log_extinction[index] )

}
</code></pre></div></div>
<p>Finally, we apply moves that slide all values in the rate vectors, <em>i.e.,</em> all speciation or extinction rates.
We will use an <code class="language-plaintext highlighter-rouge">mvVectorSlide</code> move.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvVectorSlide(log_speciation, weight=10) )
moves.append( mvVectorSlide(log_extinction, weight=10) )
</code></pre></div></div>

<p>Additionally, we apply a <code class="language-plaintext highlighter-rouge">mvShrinkExpand</code> move which changes the spread of several variables around their mean.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvShrinkExpand(log_speciation, sd=speciation_sd, weight=10) )
moves.append( mvShrinkExpand(log_extinction, sd=extinction_sd, weight=10) )
</code></pre></div></div>
<p>Both moves considerably improve the efficiency of our MCMC analysis.</p>

<h4 class="subsubsection" id="incomplete-taxon-sampling">Incomplete Taxon Sampling</h4>
<hr class="subsubsection" />

<p>We know that we have sampled 233 out of 367 living primate species.
To account for this we can set the sampling parameter as a constant node with a value of 233/367.
For simplicity, and since almost all species have been sampled, we assume <em>uniform</em> taxon sampling <a class="citation" href="#Hoehna2011">(Höhna et al. 2011; Höhna 2014)</a>,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rho &lt;- T.ntips()/367
</code></pre></div></div>

<h4 class="subsubsection" id="root-age">Root age</h4>
<hr class="subsubsection" />

<p>The birth-death process requires a parameter for the root age.
In this exercise we use a fix tree and thus we know the age of the tree.
Hence, we can get the value for the root from the <a class="citation" href="#MagnusonFord2012">Magnuson-Ford and Otto (2012)</a> tree.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root_time &lt;- T.rootAge()
</code></pre></div></div>

<h4 class="subsubsection" id="the-time-tree">The time tree</h4>
<hr class="subsubsection" />

<p>Now we have all of the parameters we need to specify the full episodic birth-death model.
We initialize the stochastic node representing the time tree.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timetree ~ dnEpisodicBirthDeath(rootAge=T.rootAge(), lambdaRates=speciation, lambdaTimes=interval_times, muRates=extinction, muTimes=interval_times, rho=rho, samplingStrategy="uniform", condition="survival", taxa=taxa)
</code></pre></div></div>
<p>You may notice that we explicitly specify that we want to condition on survival.
It is possible to change this condition to the <em>time of the process</em> or <em>the number of sampled taxa</em> too.</p>

<p>Then we attach data to the <code class="language-plaintext highlighter-rouge">timetree</code> variable.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timetree.clamp(T)
</code></pre></div></div>

<p>Finally, we create a workspace object of our whole model using the <code class="language-plaintext highlighter-rouge">model()</code> function.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymodel = model(speciation)
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">model()</code> function traversed all of the connections and found all of the nodes we specified.</p>

<h3 class="subsection" id="running-an-mcmc-analysis">Running an MCMC analysis</h3>
<hr class="subsection" />

<h4 class="subsubsection" id="specifying-monitors">Specifying Monitors</h4>
<hr class="subsubsection" />

<p>For our MCMC analysis, we need to set up a vector of <em>monitors</em> to record the states of our Markov chain.
First, we will initialize the model monitor using the <code class="language-plaintext highlighter-rouge">mnModel</code> function. This creates a new monitor variable that will output the states for all model parameters when passed into a MCMC function.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnModel(filename="output/primates_EBD_Corr.log",printgen=10, separator = TAB) )
</code></pre></div></div>

<p>Additionally, we create four separate file monitors, one for each vector of speciation and extinction rates and for each speciation and extinction rate epoch (<em>i.e.,</em> the times when the interval ends).
We want to have the speciation and extinction rates stored separately so that we can plot them nicely afterwards.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnFile(filename="output/primates_EBD_Corr_speciation_rates.log",printgen=10, separator = TAB, speciation) )
monitors.append( mnFile(filename="output/primates_EBD_Corr_speciation_times.log",printgen=10, separator = TAB, interval_times) )
monitors.append( mnFile(filename="output/primates_EBD_Corr_extinction_rates.log",printgen=10, separator = TAB, extinction) )
monitors.append( mnFile(filename="output/primates_EBD_Corr_extinction_times.log",printgen=10, separator = TAB, interval_times) )
</code></pre></div></div>

<p>Finally, create a screen monitor that will report the states of specified variables to the screen with <code class="language-plaintext highlighter-rouge">mnScreen</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnScreen(printgen=1000, beta_speciation, beta_extinction) )
</code></pre></div></div>

<h4 class="subsubsection" id="initializing-and-running-the-mcmc-simulation">Initializing and Running the MCMC Simulation</h4>
<hr class="subsubsection" />

<p>With a fully specified model, a set of monitors, and a set of moves, we can now set up the MCMC algorithm that will sample parameter values in proportion to their posterior probability.
The <code class="language-plaintext highlighter-rouge">mcmc()</code> function will create our MCMC object:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc = mcmc(mymodel, monitors, moves, nruns=2, combine="mixed")
</code></pre></div></div>

<p>Now, run the MCMC:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc.run(generations=50000, tuningInterval=200)
</code></pre></div></div>

<p>When the analysis is complete, you will have the monitored files in your output directory.
You can then visualize the rates through time using <code class="language-plaintext highlighter-rouge">R</code> using our package <code class="language-plaintext highlighter-rouge">RevGadgets</code>.
If you don’t have the R-package <code class="language-plaintext highlighter-rouge">RevGadgets</code> installed, or if you have trouble with the package, then please read the separate tutorial about the package.</p>

<p>Just start <code class="language-plaintext highlighter-rouge">R</code> in the main directory for this analysis and then type the following commands:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>library(RevGadgets)
tree &lt;- read.tree("data/primates.tre")

# the CO2 values as a reference in our plot
co2 &lt;- c(297.6, 301.36, 304.84, 307.86, 310.36, 312.53, 314.48, 316.31, 317.42, 317.63, 317.74, 318.51, 318.29, 316.5, 315.49, 317.64, 318.61, 316.6, 317.77, 328.27, 351.12, 381.87, 415.47, 446.86, 478.31, 513.77, 550.74, 586.68, 631.48, 684.13, 725.83, 757.81, 789.39, 813.79, 824.25, 812.6, 784.79, 755.25, 738.41, 727.53, 710.48, 693.55, 683.04, 683.99, 690.93, 694.44, 701.62, 718.05, 731.95, 731.56, 717.76)

MAX_VAR_AGE = 50
NUM_INTERVALS = length(co2)
co2_age &lt;- MAX_VAR_AGE * (1:NUM_INTERVALS) / NUM_INTERVALS
predictor.ages &lt;- co2_age
predictor.var &lt;- co2

rev_out &lt;- rev.process.div.rates(speciation_times_file = "output/primates_EBD_Corr_speciation_times.log",
                                 speciation_rates_file = "output/primates_EBD_Corr_speciation_rates.log",
                                 extinction_times_file = "output/primates_EBD_Corr_extinction_times.log",
                                 extinction_rates_file = "output/primates_EBD_Corr_extinction_rates.log",
                                 tree=tree,
                                 burnin=0.25,numIntervals=100)
pdf("EBD_Corr.pdf")
par(mfrow=c(2,2))
rev.plot.div.rates(rev_out, predictor.ages=co2_age, predictor.var=co2, use.geoscale=TRUE)
dev.off()
</code></pre></div></div>

<p>⇨ The <code class="language-plaintext highlighter-rouge">Rev</code> file for performing this analysis: <code class="language-plaintext highlighter-rouge">mcmc_EBD_Corr.Rev</code></p>

<h3 class="subsection" id="a-brief-discussion-on-estimated-diversification-rates">A brief discussion on estimated diversification rates</h3>
<hr class="subsection" />

<figure id="fig_EBD_Results"><p><img src="figures/EBD_Corr_1.png" width="40%" height="40%" />
<img src="figures/EBD_Corr_2.png" width="40%" height="40%" />
<img src="figures/EBD_Corr_3.png" width="40%" height="40%" />
<img src="figures/EBD_Corr_4.png" width="40%" height="40%" /></p>
<figcaption>Resulting diversification rate estimations.</figcaption>
</figure>

<p><a href="#fig_EBD_Results"></a> shows the estimated diversification rates through time and the $\text{CO}_2$.
If you compare these estimates with <a href="#fig_EBD_Results"></a> then you may notice that the diversification rate estimate are virtually identical.
This is a good sign for the analysis because it shows that the information in the estimates comes from the data (the tree in this case) and not from the assumed model.
Thus, we are not artificially forcing the diversification rates to follow our environmental variable but instead estimate if there is a correlation.
Small deviation between the estimated rates under the different analyses are expected because there will be some interaction between the environmental variable and the diversification rate estimates.
Additionally, the uncertainty in estimated diversification rates through time is large und minor changes are within this uncertainty.</p>

<h2 class="section" id="testing-for-correlation-using-reversible-jump-mcmc">Testing for correlation using reversible-jump MCMC</h2>
<hr class="section" />

<p>In the previous exercise we wanted that our model collapses to the episodic birth-death process if there is no environmental correlation.
We achieved this by setting up our prior model so that if $\beta=0$ the model collapses.
However, we also used a normal prior distribution with mean 0.0 and standard deviation 1.0 for $\beta$.
Thus, we implicitly specified that $\beta$ being exactly 0.0 has probability 0.0 because every specific value of a continuous distribution has a 0.0 probability despite having a positive probability density.
For example, you might notice that you will never sample in your MCMC run the value 0.0 exactly although we might sample values that are close to 0.0.</p>

<p>Now we want to use reversible jump MCMC to test specifically if the hypothesis $\beta=0$ is rejected.
Remember that reversible jump MCMC can estimate the posterior probability for different models.
The first model will be that $\beta=0$ and the second model will be that $\beta \sim \text{norm}(0,1)$.
Then we can simply compute Bayes factors by computing the posterior ratio divided by the prior ratio to assess the support for either model.</p>

<p>In <code class="language-plaintext highlighter-rouge">RevBayes</code> we have a very flexible way to specify a reversible-jump MCMC.
We can provide any constant value and distribution to the distribution <code class="language-plaintext highlighter-rouge">dnReversibleJumpMixture</code>.
This will mean that the value, <code class="language-plaintext highlighter-rouge">beta_speciation</code> and <code class="language-plaintext highlighter-rouge">beta_extinction</code>, will either take on the constant value or drawn from the base-distribution.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>beta_speciation ~ dnReversibleJumpMixture(constantValue=0.0, baseDistribution=dnNormal(0,1.0), p=0.5)
beta_extinction ~ dnReversibleJumpMixture(constantValue=0.0, baseDistribution=dnNormal(0,1.0), p=0.5)
</code></pre></div></div>
<p>Additionally we also need a specific move that switches if the value is equal to the constant value or drawn from the base-distribution.
This is where we use the reversible-jump move <code class="language-plaintext highlighter-rouge">mvRJSwitch</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvRJSwitch(beta_speciation, weight=5) )
moves.append( mvRJSwitch(beta_extinction, weight=5) )
</code></pre></div></div>
<p>Now we can also monitor for convenience what the probability of <code class="language-plaintext highlighter-rouge">beta_speciation</code> and <code class="language-plaintext highlighter-rouge">beta_extinction</code> being 0.0 is.
We will set this up by a deterministic variable that will be 1.0 if $\beta \neq 0$ and will be 0.0 if $\beta = 0.0$.
Thus the two variables <code class="language-plaintext highlighter-rouge">speciation_corr_prob</code> and <code class="language-plaintext highlighter-rouge">extinction_corr_prob</code> represent the probability that there is a correlation between the speciation rate or the extinction rate and $\text{CO}_2$.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speciation_corr_prob := ifelse(beta_speciation == 0.0, 0, 1)
extinction_corr_prob := ifelse(beta_extinction == 0.0, 0, 1)
</code></pre></div></div>

<p>These are the only necessary changes to the above analysis to run a reversible-jump MCMC.</p>

<ol class="bibliography"><li><span id="Beerling2011">Beerling D.J., Royer D.L. 2011. Convergent cenozoic CO2 history. Nature Geoscience. 4:418–420.</span>

</li>
<li><span id="Condamine2013">Condamine F.L., Rolland J., Morlon H. 2013. Macroevolutionary perspectives to environmental change. Ecology Letters.</span>

<a href="https://doi.org/10.1111/ele.12062">10.1111/ele.12062</a>

</li>
<li><span id="Condamine2018">Condamine F.L., Rolland J., Höhna S., Sperling F.A.H., Sanmartín I. 2018. Testing the role of the Red Queen and Court Jester as drivers of the macroevolution of Apollo butterflies. Systematic Biology. 67:940–964.</span>

</li>
<li><span id="Hoehna2016b">Höhna S., Landis M.J., Heath T.A., Boussau B., Lartillot N., Moore B.R., Huelsenbeck J.P., Ronquist F. 2016. RevBayes: Bayesian Phylogenetic Inference Using Graphical Models and an Interactive Model-Specification Language. Systematic Biology. 65:726–736.</span>

<a href="https://doi.org/10.1093/sysbio/syw021">10.1093/sysbio/syw021</a>

</li>
<li><span id="Hoehna2014a">Höhna S. 2014. Likelihood Inference of Non-Constant Diversification Rates with Incomplete Taxon Sampling. PLoS One. 9:e84184.</span>

<a href="https://doi.org/10.1371/journal.pone.0084184">10.1371/journal.pone.0084184</a>

</li>
<li><span id="Hoehna2011">Höhna S., Stadler T., Ronquist F., Britton T. 2011. Inferring speciation and extinction rates under different species sampling schemes. Molecular Biology and Evolution. 28:2577–2589.</span>

</li>
<li><span id="MagnusonFord2012">Magnuson-Ford K., Otto S.P. 2012. Linking the Investigations of Character Evolution and Species Diversification. The American Naturalist. 180:225–245.</span>

<a href="https://doi.org/10.1086/666649">10.1086/666649</a>

</li>
<li><span id="Palazzesi2022">Palazzesi L., Hidalgo O., Barreda V.D., Forest F., Höhna S. 2022. The rise of grasslands is linked to atmospheric CO\textsubscript2 decline in the late Paleogene. Nature Communications. 13:293.</span>

</li></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>

      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
