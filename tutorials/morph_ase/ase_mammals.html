<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Discrete morphology - Ancestral State Estimation (Mammals & Placenta Type)</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">Discrete morphology - Ancestral State Estimation (Mammals & Placenta Type)</h1>
	<h3 class="subtitle">Ancestral State Estimation and Testing for Irreversibility</h3>
	<h4 class="authors">Sebastian HÃ¶hna</h4>
  <h5>Last modified on February 28, 2022</h5>
</div>


<div class="sidebar no-print">
<blockquote class="overview" id="overview">
  <h2>Overview</h2>
  
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul id="prerequisites">
          
            <li><a href="/tutorials/intro/">Getting Started with RevBayes and Rev Language Syntax</a></li>
          
            <li><a href="/tutorials/intro/revgadgets.html">Introduction to RevGadgets</a></li>
          
            <li><a href="/tutorials/mcmc/">Introduction to Markov chain Monte Carlo (MCMC) Sampling</a></li>
          
            <li><a href="/tutorials/ctmc/">Nucleotide substitution models</a></li>
          
            <li><a href="/tutorials/morph_tree/">Discrete morphology - Tree Inference</a></li>
          
          </ul>
        
    </div>
  </div>
  
</blockquote>





<blockquote class="tutorial_files" id="tutorial_files">
    <h2>Data files and scripts</h2>
    
        
        <strong>Data Files</strong>
        <ul id="data_files">
        
        
        
          <li><a href="/tutorials/morph_ase/data/primates_activity_period.nex">primates_activity_period.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_diet.nex">primates_diet.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_habitat.nex">primates_habitat.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_males.nex">primates_males.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_mating_system.nex">primates_mating_system.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_morph.nex">primates_morph.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_morph_description.txt">primates_morph_description.txt</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_solitariness.nex">primates_solitariness.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_terrestrially.nex">primates_terrestrially.nex</a></li>
        
          <li><a href="/tutorials/morph_ase/data/primates_tree.nex">primates_tree.nex</a></li>
        
        </ul>
    
        
        <strong>Scripts</strong>
        <ul id="scripts">
        
        
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_ase_ERM.Rev">mcmc_ase_ERM.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_ase_freeK.Rev">mcmc_ase_freeK.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_ase_hrm_flex.Rev">mcmc_ase_hrm_flex.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_ase_irrev.Rev">mcmc_ase_irrev.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_corr.Rev">mcmc_corr.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_corr_RJ.Rev">mcmc_corr_RJ.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_corr_iid.Rev">mcmc_corr_iid.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_scm_hrm.Rev">mcmc_scm_hrm.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_scm_hrm_RJ.Rev">mcmc_scm_hrm_RJ.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/mcmc_scm_hrm_RJk.Rev">mcmc_scm_hrm_RJk.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/ml_ase_ERM.Rev">ml_ase_ERM.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/ml_ase_freeK.Rev">ml_ase_freeK.Rev</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_anc_states.R">plot_anc_states.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_anc_states_all.R">plot_anc_states_all.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_anc_states_corr_RJ.R">plot_anc_states_corr_RJ.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_anc_states_freeK.R">plot_anc_states_freeK.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_anc_states_hrm.R">plot_anc_states_hrm.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_anc_states_irrev.R">plot_anc_states_irrev.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_corr.R">plot_corr.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_hrm.R">plot_hrm.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_hrm_rates.R">plot_hrm_rates.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_iid_rates.R">plot_iid_rates.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_irrev.R">plot_irrev.R</a></li>
        
          <li><a href="/tutorials/morph_ase/scripts/plot_simmap.R">plot_simmap.R</a></li>
        
        </ul>
    
</blockquote>


</div>
<h2 class="section" id="introduction">Introduction</h2>
<hr class="section" />

<h2 class="section" id="sec_ase_example">Example: Ancestral state estimation with a simple equal rates model</h2>
<hr class="section" />

<p>In this example we will look at the evolution of morphological character <em>placenta type</em> in placental mammals.
We have three different types of placenta: Epitheliochorial(1), Endotheliochorial(2), Hemochorial(3) (<a href="#fig_placenta_types"></a> (missing reference)).
We are interested, in general, in the evolution of placenta type in placental mammals.
Specifically, we want to know what the ancestral state of all placental mammals is.
Furthermore, we want to know if placenta type is evolving under an equal-rates model, an unequal rates model, an irreversible model, or any other type of transition model.</p>

<figure id="fig_placenta_types"><p><img src="figures/placenta_types.png" /></p>
<figcaption>Visualization of different placenta types. Reproduced from (missing reference).</figcaption>
</figure>

<h3 class="subsection" id="specifying-the-mk-model">Specifying the Mk Model</h3>
<hr class="subsection" />

<p>We will start this tutorial with the simple Mk model with three states, $k=3$ <a class="citation" href="#Lewis2001">(Lewis 2001)</a>.
Thus, we will follow the <a href="/tutorials/morph_tree/">Discrete morphology - Tree Inference</a> Tutorial very closely and refer you to that tutorial for more information.</p>

<p>Let us start with defining the rate matrix $Q$ for this 3-state model:
\(Q = \begin{pmatrix} -\mu_1 &amp; \mu_{12} &amp; \mu_{13} \\
\mu_{21} &amp; -\mu_2  &amp; \mu_{23} \\
\mu_{31} &amp; \mu_{32} &amp; -\mu_3
\end{pmatrix} \mbox{  .}\)</p>

<p>Remember, the Mk model sets transitions to be equal from any state to any other state.
In that sense, our 3-state matrix really looks like this:
\(Q = \begin{pmatrix} -(k-1)\mu &amp; \mu &amp; \mu \\
\mu &amp; -(k-1)\mu  &amp; \mu \\
\mu &amp; \mu &amp; -(k-1)\mu \\
\end{pmatrix} \mbox{  .}\)</p>

<p>Because this is a Jukes-Cantor-like model <a class="citation" href="#Jukes1969">(Jukes and Cantor 1969)</a>, state frequencies do not vary as a model parameter.
A visualization of this simple model can be seen in <a href="#fig_gm_m3"></a>.</p>

<figure id="fig_gm_m3"><p><img src="figures/tikz/Mk_model.png" /></p>
<figcaption>Graphical model showing the Mk model (left panel). Rev code specifying the Mk model is on the right-hand panel.</figcaption>
</figure>

<p>We will first perform a phylogenetic analysis using the Mk model.
In further sections, we will explore how to relax key assumptions of the Mk model.</p>

<h2 class="section" id="sec_dm_simple">Example: Ancestral State Estimation Using the Mk Model</h2>
<hr class="section" />

<p>In this example, we will use the placenta type data applied to a thinned phylogeny of placental mammals.
We have thinned the phylogeny only so that it will run considerably fast for this tutorial.
Our actual analysis uses the full dataset of $\sim 5000$ taxa.</p>

<h3 class="subsection" id="subsec_data_files">Data and Files</h3>
<hr class="subsection" />

<blockquote class="instruction">
  <p>Create a directory called <code class="language-plaintext highlighter-rouge">RB_DiscreteMorphology_RateASE_Tutorial</code> (or any name you like).</p>

  <p>Make sure that you have the data files copied into a subdirectory called <code class="language-plaintext highlighter-rouge">data</code>: .</p>
</blockquote>

<h3 class="subsection" id="subsec_get_start">Getting Started</h3>
<hr class="subsection" />

<blockquote class="instruction">
  <p>Create a new directory (in <code class="language-plaintext highlighter-rouge">RB_DiscreteMorphology_RateASE_Tutorial) called </code>scripts`.
(If you do not have this folder, please refer to the directions in section <a href="#subsec_data_files"></a>.)</p>
</blockquote>

<p>When you execute RevBayes in this exercise, you will do so within the main directory you created (<code class="language-plaintext highlighter-rouge">RB_DiscreteMorphology_RateASE_Tutorial</code>).</p>

<h3 class="subsection" id="subsec_creating_files">Creating Rev Files</h3>
<hr class="subsection" />

<p>For complex models and analyses, it is best to create Rev script files that will contain all of the model parameters, moves, and functions.
In this exercise, you will work primarily in your text editor and create a set of files that will be easily managed and interchanged.
In this first section, you will write the following files from scratch and save them in the <code class="language-plaintext highlighter-rouge">scripts</code> directory:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">mcmc_ase_mk.Rev</code>: the Rev-script file that loads the data, specifies the model describing discrete morphological character change (binary characters), and specifies the monitors and MCMC sampler.</li>
</ul>

<p>All of the files that you will create are also provided in the this RevBayes tutorial.
Please refer to these files to verify or troubleshoot your own scripts.</p>

<blockquote class="instruction">
  <p>Open your text editor and create the master Rev file called <code class="language-plaintext highlighter-rouge">mcmc_ase_Mk.Rev</code> in the <code class="language-plaintext highlighter-rouge">scripts</code> directory.</p>

  <p>Enter the Rev code provided in this section in the new model file.</p>
</blockquote>

<p>The file you will begin in this section will be the one you load into RevBayes when you have completed all of the components of the analysis.
In this section you will begin the file and write the Rev commands for loading in the taxon list and managing the data matrices.
Then, starting in section <a href="#subsec_Mk_Model"></a>, you will move on to writing module files for each of the model components.
Once the model files are complete, you will return to editing <code class="language-plaintext highlighter-rouge">mcmc_ase_Mk.Rev</code> and complete the Rev script with the instructions given in section <a href="#subsec_complete_MCMC"></a>.</p>

<h4 class="subsubsection" id="subsubsec_load_data">Load Data Matrices</h4>
<hr class="subsubsection" />

<p>RevBayes uses the function <code class="language-plaintext highlighter-rouge">readDiscreteCharacterData()</code> to load a data matrix to the workspace from a formatted file.
This function can be used for both molecular sequences and discrete morphological characters.
Import the morphological character matrix and assign it to the variable <code class="language-plaintext highlighter-rouge">morpho</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>morpho &lt;- readDiscreteCharacterData("data/mammals_thinned_placenta_type.nex")
</code></pre></div></div>

<h4 class="subsubsection" id="subsubsec_var">Create Helper Variables</h4>
<hr class="subsubsection" />

<p>Before we begin writing the Rev scripts for each of the model components, we need to instantiate a couple ``helper variablesââ that will be used by downstream parts of our model specification files.
Create vectors of moves and monitors</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves = VectorMoves()
monitors = VectorMonitors()
</code></pre></div></div>

<h3 class="subsection" id="subsec_Mk_Model">The Mk Model</h3>
<hr class="subsection" />

<p>First, we read in the tree topology:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phylogeny &lt;- readTrees("data/mammals_thinned.tree")[1]
</code></pre></div></div>

<p>Next, we will create a Q matrix.
Recall that the Mk model is simply a generalization of the JC model.
Therefore, we will create a 3x3 Q matrix using <code class="language-plaintext highlighter-rouge">fnJC</code>, which initializes $Q$-matrices with equal transition probabilities between all states.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Q_morpho &lt;- fnJC(3)
</code></pre></div></div>

<p>Now that we have the basics of the model specified, we will specify the only parameter of the model, $\mu$.
The parameter specifies all the rates of morphological evolution:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mu_morpho ~ dnExponential( 1.0 )
</code></pre></div></div>
<p>Since $\mu$ is a rate parameter, we will apply a scaling move to update it.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvScale(mu_morpho,lambda=1, weight=2.0) )
</code></pre></div></div>

<p>Lastly, we set up the CTMC.
This should be familiar from the <a href="/tutorials/ctmc/">Nucleotide substitution models</a> tutorial.
We see some familiar pieces: tree and Q matrix.
We also have two new keywords: data type and coding.
The data type argument specifies the type of data - in our case, âStandardâ, the specification for morphology.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phyMorpho ~ dnPhyloCTMC(tree=phylogeny, branchRates=mu_morpho, Q=Q_morpho, type="Standard")
phyMorpho.clamp(morpho)
</code></pre></div></div>

<p>All of the components of the model are now specified.</p>

<h3 class="subsection" id="subsec_complete_MCMC">Complete MCMC Analysis</h3>
<hr class="subsection" />

<h4 class="subsubsection" id="subsubsec_Mod_Obj">Create Model Object</h4>
<hr class="subsubsection" />

<p>We can now create our workspace model variable with our fully specified model DAG.
We will do this with the <code class="language-plaintext highlighter-rouge">model()</code> function and provide a single node in the graph (<code class="language-plaintext highlighter-rouge">phylogeny</code>).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymodel = model(phylogeny)
</code></pre></div></div>

<p>The object <code class="language-plaintext highlighter-rouge">mymodel</code> is a wrapper around the entire model graph and allows us to pass the model to various functions that are specific to our MCMC analysis.</p>

<h4 class="subsubsection" id="subsubsec_Monitors">Specify Monitors and Output Filenames</h4>
<hr class="subsubsection" />

<p>The next important step for our Rev script file is to specify the monitors and output file names.
The first monitor we will create will monitor every named random variable in our model graph.
This will include every stochastic and deterministic node using the <code class="language-plaintext highlighter-rouge">mnModel</code> monitor.
In this case, it will only be our rate variable $\mu$.
It is still useful to specify the model monitor this way for later extensions of the model.
We will also name the output file for this monitor and indicate that we wish to sample our MCMC every 10 cycles.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnModel(filename="output/mk.log", printgen=10) )
</code></pre></div></div>

<p>The second monitor we will add to our analysis will print information to the screen.
Like with <code class="language-plaintext highlighter-rouge">mnFile</code> we must tell <code class="language-plaintext highlighter-rouge">mnScreen</code> which parameters weâd like to see updated on the screen.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnScreen(printgen=100) )
</code></pre></div></div>

<p>The third and final monitor might be new to you: the <code class="language-plaintext highlighter-rouge">mnJointConditionalAncestralState</code> monitor computes and writes the ancestral states to file.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnJointConditionalAncestralState(tree=phylogeny,
                                                   ctmc=phyMorpho,
                                                   filename="output/mk.states.txt",
                                                   type="Standard",
                                                   printgen=1,
                                                   withTips=true,
                                                   withStartStates=false) )
</code></pre></div></div>

<p>The core arguments this monitor needs are a tree object (<code class="language-plaintext highlighter-rouge">tree=phylogeny</code>),
the phylogenetic model (<code class="language-plaintext highlighter-rouge">ctmc=phyMorpho</code>), an output filename (<code class="language-plaintext highlighter-rouge">filename="output/mk.states.txt"</code>),
the data type for the characters (<code class="language-plaintext highlighter-rouge">type="Standard"</code>), and the sampling frequency (<code class="language-plaintext highlighter-rouge">printgen=10}</code>.
The final argument, <code class="language-plaintext highlighter-rouge">withTips=true</code>, indicates that we do wish to record the tip states because we didnât know all tip values and might be interested in the most plausible values.</p>

<p>The monitor will produce a joint sample of ancestral states, where every ancestral state is conditional on the drawn value of its parent node state (except for the root node),
storing the samples every 10 iterations to the file <code class="language-plaintext highlighter-rouge">"output/mk.states.txt"</code>.
Viewing the states file, we see</p>
<div class="language-plaintext Rev-output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Iteration	end_1	end_2	end_3	end_4	end_5	...
0	2	3	3	3	3	...
1	2	3	3	3	3	...
2	2	3	3	3	3	...
3	2	3	3	3	3	...
4	2	3	3	3	3	...
5	2	3	3	3	3	...
6	2	3	3	3	3	...
7	2	3	3	3	3	...
8	2	3	3	3	3	...
9	2	3	3	3	3	...
10	2	3	3	3	3	...
...
</code></pre></div></div>

<h4 class="subsubsection" id="set-up-the-mcmc">Set-Up the MCMC</h4>
<hr class="subsubsection" />

<p>Once we have set up our model, moves, and monitors, we can now create the workspace variable that defines our MCMC run.
We do this using the <code class="language-plaintext highlighter-rouge">mcmc()</code> function that simply takes the three main analysis components as arguments.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc = mcmc(mymodel, monitors, moves, nruns=2, combine="mixed")
</code></pre></div></div>

<p>The MCMC object that we named <code class="language-plaintext highlighter-rouge">mymcmc</code> has a member method called <code class="language-plaintext highlighter-rouge">.run()</code>.
This will execute our analysis and we will set the chain length to <code class="language-plaintext highlighter-rouge">10000</code> cycles using the <code class="language-plaintext highlighter-rouge">generations</code> option.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc.run(generations=10000, tuningInterval=200)
</code></pre></div></div>

<p>Once our Markov chain has terminated, we will process the ancestral state samples.
This function will compute the posterior probabilities of the ancestral states from the samples.
Later we can visuallize our ancestral states.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anc_states = readAncestralStateTrace("output/mk.states.txt")
anc_tree = ancestralStateTree(tree=phylogeny, ancestral_state_trace_vector=anc_states, include_start_states=false, file="output/ase_mk.tree", burnin=0.25, summary_statistic="MAP", site=1)
writeNexus( anc_tree, filename="output/ase_mk.tree" )
</code></pre></div></div>

<p>Finally we can close RevBayes.
Tell the program to quit using the <code class="language-plaintext highlighter-rouge">q()</code> function.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>q()
</code></pre></div></div>

<blockquote class="instruction">
  <p>You made it! Save your file.</p>
</blockquote>

<h3 class="subsection" id="subsec_run_MCMC">Execute the MCMC Analysis</h3>
<hr class="subsection" />

<p>With all the parameters specified and all analysis components in place, you are now ready to run your analysis.
The Rev script you just created will be used by RevBayes and loaded in the appropriate order.</p>

<blockquote class="instruction">
  <p>Begin by running the RevBayes executable.</p>
</blockquote>

<p>Provided that you started RevBayes from the correct directory (<code class="language-plaintext highlighter-rouge">RB_DiscreteMorphology_RateASE_Tutorial</code>),
you can then use the <code class="language-plaintext highlighter-rouge">source()</code> function to feed RevBayes your master script file (<code class="language-plaintext highlighter-rouge">mcmc_ase_mk.Rev</code>).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source("scripts/mcmc_ase_mk.Rev")
</code></pre></div></div>
<p>This will execute the analysis and you should see the following output (though not the exact same values):</p>
<div class="language-plaintext Rev-output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Processing file "scripts/mcmc_ase_mk.Rev"
   Successfully read one character matrix from file 'data/mammals_thinned_placenta_type.nex'
   Attempting to read the contents of file "mammals_thinned.tree"
   Successfully read file

   Running MCMC simulation
   This simulation runs 2 independent replicates.
   The simulator uses 1 different moves in a random move schedule with 2 moves per iteration

Iter        |      Posterior   |     Likelihood   |          Prior   |    elapsed   |        ETA   |
----------------------------------------------------------------------------------------------------
0           |       -359.492   |       -359.194   |      -0.298007   |   00:00:00   |   --:--:--   |
100         |       -62.0258   |       -62.0245   |     -0.0013356   |   00:00:03   |   --:--:--   |
200         |       -62.3349   |       -62.3336   |    -0.00123787   |   00:00:05   |   00:02:00   |
300         |        -62.005   |       -62.0024   |    -0.00256593   |   00:00:07   |   00:01:49   |
400         |       -61.3682   |       -61.3664   |    -0.00177658   |   00:00:09   |   00:01:43   |
500         |        -61.683   |       -61.6807   |    -0.00235834   |   00:00:12   |   00:01:48   |

...
</code></pre></div></div>

<p>When the analysis is complete, RevBayes will quit and you will have a new directory called <code class="language-plaintext highlighter-rouge">output</code> that will contain all of the files you specified with the monitors (Section <a href="#subsubsec_Monitors"></a>).</p>

<h2 class="section" id="plotting-the-tree-with-ancestral-states">Plotting the tree with ancestral states</h2>
<hr class="section" />

<p>We will now switch to <code class="language-plaintext highlighter-rouge">R</code> using the package <code class="language-plaintext highlighter-rouge">RevGadgets</code>.
Make sure that you have the package installed, using</p>

<pre><code class="language-{R}">library(devtools)
install_github("GuangchuangYu/ggtree")
install_github("revbayes/RevGadgets")
</code></pre>
<p>Now that we have our posterior distribution of ancestral states, we want to visualize those results.
This section will aim to produce a pdf containing figures for the ancestral state estimates.</p>

<p>We have written a little R package called \RevGadgets that can be used to visualize the output of \RevBayes.</p>

<blockquote class="instruction">
  <p>Start R from the same working directory as you started RevBayes.
This should be the directory where you now have you directory called <code class="language-plaintext highlighter-rouge">output</code> with the MCMC output files.</p>
</blockquote>

<p>First, we need to load the R package RevGadgets</p>
<pre><code class="language-{R}">library(RevGadgets)
</code></pre>

<p>Second, we specify the name of the tree file.</p>
<pre><code class="language-{R}">tree_file = "output/ase_mk.tree"
</code></pre>

<p>Then, you plot the tree with ancestral states nicely mapped onto it.
You may want to experiment with some of the settings to make the plot look prettier.
For example, if you set <code class="language-plaintext highlighter-rouge">show_posterior_legend=TRUE</code> and <code class="language-plaintext highlighter-rouge">node_size_range=c(1, 3)</code>,
then the size of the circles will represent the posterior probability.</p>
<pre><code class="language-{R}">g &lt;- plot_ancestral_states(tree_file, summary_statistic="MAP",
                      tip_label_size=1,
                      xlim_visible=NULL,
                      node_label_size=0,
                      show_posterior_legend=FALSE,
                      node_size_range=c(2.5, 2.5),
                      alpha=0.75)
</code></pre>

<p>Finally, we save the output into a PDF.</p>
<pre><code class="language-{R}">ggsave("Mammals_ASE_MK.pdf", g, width = 11, height = 9)
</code></pre>

<blockquote class="instruction">
  <p>You can also find all these commands in the file called <strong>plot_anc_states.R</strong> which you can run as a script in R.</p>
</blockquote>

<p><a href="#fig_mk_anc_states"></a> shows the result of this analysis.</p>

<figure id="fig_mk_anc_states"><p><img src="figures/Mammals_ASE_MK.png" /></p>
<figcaption>Ancestral state estimation of the placenta type.</figcaption>
</figure>

<h2 class="section" id="sec_ase_unequal">Example: Unequal Transition Rates</h2>
<hr class="section" />

<blockquote class="instruction">
  <p>Make a copy of the MCMC and model files you just made.
Call them <code class="language-plaintext highlighter-rouge">mcmc_ase_mk.Rev</code> and `model_ase_FreeK.Rev.
These will contain the new model parameters and models.</p>
</blockquote>

<p>The Mk model makes a number of assumptions, but one that may strike you as unrealistic
is the assumption that characters are equally likely to change from any one state to any other state.
That means that a trait is as likely to be gained as lost.
While this may hold true for some traits, we expect that it may be untrue for many others.</p>

<p>RevBayes has functionality to allow us to relax this assumption.</p>

<h3 class="subsection" id="modifying-the-mcmc-section">Modifying the MCMC Section</h3>
<hr class="subsection" />

<p>At each place in which the output files are specified in the MCMC file, change the output path so you donât overwrite the output from the previous exercise.
For example, you might call your output file <code class="language-plaintext highlighter-rouge">output/ase_freeK.log</code>.
Change source statement to indicate the new model file.</p>

<h3 class="subsection" id="modifying-the-model-section">Modifying the Model Section</h3>
<hr class="subsection" />

<p>Our goal here is to create a rate matrix with 6 free parameters.
We will assume an exponential prior distribution for each of the rates.
Thus, we start be specifying the rate of this exponential prior distribution.
A good guess might be that 10 events happened along the tree, so the rate should be the tree-length divided by 10.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rate_pr := phylogeny.treeLength() / 10
</code></pre></div></div>

<p>Now we can create our six independent rate variables drawn from an identical exponential distribution</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rate_12 ~ dnExponential(rate_pr)
rate_13 ~ dnExponential(rate_pr)
rate_21 ~ dnExponential(rate_pr)
rate_23 ~ dnExponential(rate_pr)
rate_31 ~ dnExponential(rate_pr)
rate_32 ~ dnExponential(rate_pr)
</code></pre></div></div>
<p>As usual, we will apply a scaling move to each of the rate variables.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvScale( rate_12, weight=2 ) )
moves.append( mvScale( rate_13, weight=2 ) )
moves.append( mvScale( rate_21, weight=2 ) )
moves.append( mvScale( rate_23, weight=2 ) )
moves.append( mvScale( rate_31, weight=2 ) )
moves.append( mvScale( rate_32, weight=2 ) )
</code></pre></div></div>
<p>Next, we put all the rates together into our rate matrix.
Donât forget to say that we do not rescale the rate matrix (<code class="language-plaintext highlighter-rouge">rescale=false</code>).
We would only rescale if we use relative rates.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Q_morpho := fnFreeK( [ rate_12, rate_13, rate_21, rate_23, rate_31, rate_32 ], rescale=false )
</code></pre></div></div>

<p>In this model, we also decide to specify an additional parameter for the root state frequencies instead of assuming the root state to be drawn from the stationary distribution.
We will use a Dirichlet prior distribution for the root state frequencies.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rf_prior &lt;- [1,1,1]
rf ~ dnDirichlet( rf_prior )
moves.append( mvBetaSimplex( rf, weight=2 ) )
moves.append( mvDirichletSimplex( rf, weight=2 ) )
</code></pre></div></div>

<p>We need to modify the <code class="language-plaintext highlighter-rouge">dnPhyloCTMC</code> to pass in our new root frequencies parameter.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phyMorpho ~ dnPhyloCTMC(tree=phylogeny, Q=Q_morpho, rootFrequencies=rf, type="Standard")
</code></pre></div></div>

<blockquote class="instruction">
  <p>Now you are done with your unequal rates model. Give it a run!</p>
</blockquote>

<h2 class="section" id="sec_ase_ir_rj">Reversible-jump MCMC to test for irreversibility</h2>
<hr class="section" />

<p>In the previous section we assumed that there are 6 different rates, which are all $&gt;0$.
Now, we will apply a reversible-jump MCMC (missing reference) to test if any of the rates is significantly larger than $0$.</p>

<blockquote class="instruction">
  <p>Make a copy of the Rev script file you just made.
Call them `mcmc_ase_freeK_RJ.Rev.
This will contain the new model parameters and models.</p>
</blockquote>

<h3 class="subsection" id="modifying-the-mcmc-section">Modifying the MCMC Section</h3>
<hr class="subsection" />

<p>At each place in which the output files are specified in the MCMC section, change the output path so you donât overwrite the output from the previous exercise.
For example, you might call your output file <code class="language-plaintext highlighter-rouge">output/freeK_ASE.log</code>.</p>

<h3 class="subsection" id="modifying-the-model-section">Modifying the Model Section</h3>
<hr class="subsection" />

<p>The only part in the model section that we are going to modify is the prior distributions and moves on the rate parameters.
We will assume the same rate for the exponential prior distribution as before.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rate_pr := phylogeny.treeLength() / 10
</code></pre></div></div>
<p>Next, we specify that we have a 0.5 probability, <em>a priori</em>, that a rate is equal to 0.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix_pr &lt;- 0.5
</code></pre></div></div>

<p>Now we can create our reversible-jump distributions, which take in a constant value, 0.0 in this case, and a distribution.
Thus, the value is either drawn to be exactly equal to the constant value (0.0 here), or drawn from the base distribution (the exponential distribution in this case).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rate_12 ~ dnRJMixture(0.0, dnExponential(rate_pr), p=mix_pr)
rate_13 ~ dnRJMixture(0.0, dnExponential(rate_pr), p=mix_pr)
rate_21 ~ dnRJMixture(0.0, dnExponential(rate_pr), p=mix_pr)
rate_23 ~ dnRJMixture(0.0, dnExponential(rate_pr), p=mix_pr)
rate_31 ~ dnRJMixture(0.0, dnExponential(rate_pr), p=mix_pr)
rate_32 ~ dnRJMixture(0.0, dnExponential(rate_pr), p=mix_pr)
</code></pre></div></div>

<p>Since we are interested in the probability that a rate is equal to 0.0, we want to compute this posterior probability directly.
Therefore, we will use the <code class="language-plaintext highlighter-rouge">ifelse</code> function, which will return 1.0 if the rate is equal to 0.0, and 0.0 otherwise (if the rate is unequal to 0.0).
Hence, the frequency with which we sample a 1.0 gives us the posterior probability that a given rate is equal to 0.0.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prob_rate_12 := ifelse( rate_12 == 0, 1.0, 0.0 )
prob_rate_13 := ifelse( rate_13 == 0, 1.0, 0.0 )
prob_rate_21 := ifelse( rate_21 == 0, 1.0, 0.0 )
prob_rate_23 := ifelse( rate_23 == 0, 1.0, 0.0 )
prob_rate_31 := ifelse( rate_31 == 0, 1.0, 0.0 )
prob_rate_32 := ifelse( rate_32 == 0, 1.0, 0.0 )
</code></pre></div></div>

<p>We also need to specify specific moves that ``jumpââ in parameter dimension.
We will use the <code class="language-plaintext highlighter-rouge">mvRJSwitch</code> move that changes the value to be either equal to the constant value
provided from the <code class="language-plaintext highlighter-rouge">dnRJMixture</code> or a value drawn from the base distribution (the exponential distribution).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvRJSwitch( rate_12, weight=2 ) )
moves.append( mvRJSwitch( rate_13, weight=2 ) )
moves.append( mvRJSwitch( rate_21, weight=2 ) )
moves.append( mvRJSwitch( rate_23, weight=2 ) )
moves.append( mvRJSwitch( rate_31, weight=2 ) )
moves.append( mvRJSwitch( rate_32, weight=2 ) )
</code></pre></div></div>

<p>Additionally, we also need to specify moves that change the rates if they are not equal to 0.0.
As usual, we use the standard scaling moves.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves.append( mvScale( rate_12, weight=2 ) )
moves.append( mvScale( rate_13, weight=2 ) )
moves.append( mvScale( rate_21, weight=2 ) )
moves.append( mvScale( rate_23, weight=2 ) )
moves.append( mvScale( rate_31, weight=2 ) )
moves.append( mvScale( rate_32, weight=2 ) )
</code></pre></div></div>

<blockquote class="instruction">
  <p>This is all that you need to do for this ``fancyââ reversible-jump model. Give it a try!</p>
</blockquote>

<h2 class="section" id="sec_ase_results">Evaluate and Summarize Your Results</h2>
<hr class="section" />

<h3 class="subsection" id="subsec_ase_plots">Visualizing Ancestral State Estimates</h3>
<hr class="subsection" />

<p>We have previously seen in <a href="#fig_mk_anc_states"></a> how the ancestral states of the simple model look.
You should repeat plotting the ancestral states now also for the <code class="language-plaintext highlighter-rouge">freeK</code> and <code class="language-plaintext highlighter-rouge">freeK_RJ</code> analyses.
My output is shown in <a href="#fig_mk_anc_states_freeK"></a></p>

<figure id="fig_mk_anc_states_freeK"><p><img src="figures/Mammals_ASE_FreeK.png" /></p>
<figcaption>Ancestral state estimates of placenta type under the <code class="language-plaintext highlighter-rouge">freeK</code> model.</figcaption>
</figure>

<p>You should observe that the estimated root states have changed!</p>

<ol class="bibliography"><li><span id="Jukes1969">Jukes T.H., Cantor C.R. 1969. Evolution of Protein Molecules. Mammalian Protein Metabolism. 3:21â132.</span>

<a href="https://doi.org/10.1016/B978-1-4832-3211-9.50009-7">10.1016/B978-1-4832-3211-9.50009-7</a>

</li>
<li><span id="Lewis2001">Lewis P.O. 2001. A Likelihood Approach to Estimating Phylogeny from Discrete Morphological Character Data. Systematic Biology. 50:913â925.</span>

<a href="https://doi.org/10.1080/106351501753462876">10.1080/106351501753462876</a>

</li></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>

      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
