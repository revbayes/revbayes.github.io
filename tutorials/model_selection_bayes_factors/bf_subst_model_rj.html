<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Model averaging of substitution models</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="https://revbayes.github.io/revscripter/">RevScripter</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="titlebar">
	<h1 class="maintitle">Model averaging of substitution models</h1>
	<h3 class="subtitle">Reversible-jump MCMC over substitution models</h3>
	<h4 class="authors">Mike May and Sebastian Höhna</h4>
  <h5>Last modified on September 12, 2019</h5>
</div>


<div class="sidebar no-print">
<blockquote class="overview" id="overview">
  <h2>Overview</h2>
  
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul id="prerequisites">
          
            <li><a href="/tutorials/intro/">Getting Started with RevBayes and Rev Language Syntax</a></li>
          
            <li><a href="/tutorials/mcmc/">Introduction to Markov chain Monte Carlo (MCMC) Sampling</a></li>
          
            <li><a href="/tutorials/model_selection_bayes_factors/bf_intro.html">General Introduction to Model selection</a></li>
          
            <li><a href="/tutorials/model_selection_bayes_factors/bf_subst_model.html">Model selection of common substitution models for one locus</a></li>
          
          </ul>
        
    </div>
  </div>
  
</blockquote>





<blockquote class="tutorial_files" id="tutorial_files">
    <h2>Data files and scripts</h2>
    
        
        <strong>Data Files</strong>
        <ul id="data_files">
        
        
        
          <li><a href="/tutorials/model_selection_bayes_factors/data/fagus_ITS.nex">fagus_ITS.nex</a></li>
        
          <li><a href="/tutorials/model_selection_bayes_factors/data/fagus_matK.nex">fagus_matK.nex</a></li>
        
          <li><a href="/tutorials/model_selection_bayes_factors/data/fagus_rbcL.nex">fagus_rbcL.nex</a></li>
        
          <li><a href="/tutorials/model_selection_bayes_factors/data/primates_and_galeopterus_cox2.nex">primates_and_galeopterus_cox2.nex</a></li>
        
        </ul>
    
        
        <strong>Scripts</strong>
        <ul id="scripts">
        
        
        
          <li><a href="/tutorials/model_selection_bayes_factors/scripts/model_average_primates_cytb.Rev">model_average_primates_cytb.Rev</a></li>
        
        </ul>
    
</blockquote>


</div>
<h2 class="section" id="overview">Overview</h2>
<hr class="section" />

<p>You should read first the <a href="/tutorials/model_selection_bayes_factors/bf_intro.html">General Introduction to Model selection</a> tutorial, which explains the theory and 
standard algorithms for estimating marginal likelihoods and Bayes factors.
Additionally, you may want to work through the <a href="/tutorials/model_selection_bayes_factors/bf_subst_model.html">Model selection of common substitution models for one locus</a> tutorial,
which estimates marginal likelihoods for different substitution models for one locus, before attempting this tutorial.</p>

<h2 class="section" id="bayesian-model-averaging">Bayesian Model Averaging</h2>
<hr class="section" />

<p>Sometimes, the data are indecisive about which model is preferred by Bayes factor.
We call this phenomenon <em>model uncertainty</em> because we’re actually uncertain about 
which model is the best description of the process that generated our data. 
The natural Bayesian solution to this problem is simply to treat the model itself as a random variable, 
which averages parameter estimates (including the tree, branch lengths, 
and all substitution model parameters) over the uncertainty in the model itself. 
We accomplish this (generally) using a special “reversible-jump” MCMC algorithm 
(also known “rjMCMC”, “transdimensional MCMC”, or “the Green algorithm”) 
which adds, removes, or combines parameters to move between models.</p>

<p>The state space of potential models is vast, so we’ll restrict ourselves to a very particular set of 
models, in particular, we’re going to average over the “named” members of the GTR models 
(the ones you learned specifically in class) and models with and without Gamma-distributed ASRV.</p>

<h3 class="subsection" id="averaging-over-q-matrices">Averaging over $Q$-matrices</h3>
<hr class="subsection" />

<p>We average over $Q$-matrices by including all of the relevant parameters ($\kappa$, $\pi$, $r$) in our model, 
and using a <em>model indicator</em> to indicate which parameters to include in the model. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kappa ~ dnExp(1)
moves.append( mvScale(kappa, weight=5.0) )

pi ~ dnDirichlet(v(1,1,1,1))
moves.append( mvBetaSimplex(pi, weight=5.0) )

er ~ dnDirichlet(v(1,1,1,1,1,1))
moves.append( mvBetaSimplex(er, weight=5.0) )

Q_JC  &lt;- fnJC(4)
Q_K80 := fnK80(kappa)
Q_F81 := fnF81(pi)
Q_HKY := fnHKY(kappa, pi)
Q_GTR := fnGTR(er, pi)

Q_vec := v(Q_JC, Q_K80, Q_F81, Q_HKY, Q_GTR)

model_indicator ~ dnCategorical(simplex(1,1,1,1,1))
moves.append( mvRandomGeometricWalk(model_indicator, weight=10.0, tune=FALSE)

Q := Q_vec[model_indicator]
</code></pre></div></div>

<p>In this case, we have a vector of $Q$ matrices that are assembled from the relevant parameters, 
and another parameter (the indicator) that allows us to move between $Q$ matrices!</p>

<h3 class="subsection" id="reversible-jump-for-gamma-distributed-asrv">Reversible-Jump for Gamma-distributed ASRV</h3>
<hr class="subsection" />

<p>Including reversible-jump for Gamma-distributed ASRV is more straightforward:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alpha ~ dnReversibleJumpMixture(1E8, dnUniform(0,1E8), 0.5)
alpha.setValue(1.0)
moves.append( mvRJSwitch(alpha, weight=10.0) )
moves.append( mvScale(alpha, weight=10.0) )

alpha_indicator := ifelse(alpha == 1E8, 0, 1)

site_rates := fnDiscretizeGamma(alpha, alpha, 4)
</code></pre></div></div>
<p>Here, we draw <code class="language-plaintext highlighter-rouge">alpha</code> from a “reversibe jump mixture”, which specifies the value of <code class="language-plaintext highlighter-rouge">alpha</code> 
when ASRV is “turned off” (the first argument), the prior distribution from which <code class="language-plaintext highlighter-rouge">alpha</code> is drawn 
when the ASRV is “turned on” (the second argument), and the prior probability that ASRV is “turned on” (the final argument). 
The <code class="language-plaintext highlighter-rouge">alpha_indicator</code> parameter will have a value of 1 when ASRV is “turned on” 
and a value of 0 when it is “turned off”. 
We’re using a value of <code class="language-plaintext highlighter-rouge">alpha=1e8</code> to approximate “no rate variation”, 
because, as $\alpha \rightarrow \infty$, the Gamma-model collapse to a spike at 1 (i.e., approximately no rate variation):</p>

<figure id="gamma_rates"><p><img src="figures/gammas.png" width="75%" /></p>
<figcaption>Gamma distribution for different choices of $\alpha$.</figcaption>
</figure>

<p>Using reversible jump, we can actually estimate the posterior probability of each model! In this case, the posterior probability of a model for a particular locus is the frequency with which it is sampled in the posterior distribution; in this case, the posterior probability of the rate-variable model is the fraction of MCMC samples that aren’t 10000, which is also the posterior mean value of the <code class="language-plaintext highlighter-rouge">alpha_indicator</code> parameter!</p>

<h3 class="subsection" id="in-class-exercises">In-Class Exercises</h3>
<hr class="subsection" />

<ol>
  <li>Download and run the <code class="language-plaintext highlighter-rouge">model_average_primates_cytb.Rev</code> script. 
Examine the posterior distributions of the <code class="language-plaintext highlighter-rouge">model_indicator</code> and <code class="language-plaintext highlighter-rouge">alpha_indicator</code> parameters in Tracer. 
What is the posterior probability that our model includes Gamma-distributed rate variation? 
What is the $Q$ matrix with the highest posterior probability? What substitution models are in the 95% credible set?</li>
  <li>Repeat the above exercise for <code class="language-plaintext highlighter-rouge">matK</code> and <code class="language-plaintext highlighter-rouge">rbcL</code> by making the appropriate changes to the <code class="language-plaintext highlighter-rouge">model_average_primates_cytb.Rev</code> script. 
Are these results consistent with the Bayes factors we computed in the first section of the tutorial?</li>
</ol>


<ol class="bibliography"></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>

      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

  </body>
</html>
