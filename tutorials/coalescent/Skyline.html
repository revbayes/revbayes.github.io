<!doctype html>
<html lang="en">
<link rel="icon" type="image/png" href="/assets/img/favicon.png" >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <title>RevBayes: Skyline Models</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/" class="pull-left">
        
        <img class="navbar-logo" src="/assets/img/aquabayes-desaturated.png" alt="RevBayes Home" />
        
      </a>

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/download">Download</a></li>
        <li><a href="/tutorials/">Tutorials</a></li>
        <li><a href="/documentation/">Documentation</a></li>
        <li><a href="/interfaces">Interfaces</a></li>
        <li><a href="/workshops/">Workshops</a></li>
        <li><a href="/jobs/">Jobs</a></li>
        <li><a href="/developer/">Developer</a></li>
        <li><class="header-search">
  <form class="header-search-form" action="/search.html" method="get">
    <input type="text" id="search-box-nav" placeholder="Search..." name="query" style="border-color:black;background-color:white;height:32px;">
    <button type="submit" style="color:black; border-color:black;width:32px;height:32px;padding-top:4px">
        <img src="https://revbayes.github.io/assets/img/search.png" height="22px" width="28px"/>
    </button>
  </form>
</div>

</li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <!-- adds margin to main content -->
      <div class="container" style="padding-left:20px padding-right:20px;">
          <div class="titlebar">
	<h1 class="maintitle">Skyline Models</h1>
	<h3 class="subtitle">Estimating Demographic Histories with Skyline Models</h3>
	<h4 class="authors">Ronja Billenstein and Sebastian HÃ¶hna</h4>
  <h5>Last modified on March 13, 2024</h5>
</div>


<div class="sidebar no-print">
<blockquote class="overview" id="overview">
  <h2>Overview</h2>
  
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul id="prerequisites">
          
            <li><a href="/tutorials/coalescent/">Coalescent Analyses</a></li>
          
            <li><a href="/tutorials/coalescent/Constant.html">Constant Coalescent Model</a></li>
          
          </ul>
        
    </div>
  </div>
  
</blockquote>





<blockquote class="tutorial_files" id="tutorial_files">
    <h2>Data files and scripts</h2>
    
        
        <strong>Other</strong>
        <ul id="other_files">
        
        
        
          <li><a href="/tutorials/coalescent/data/horses_isochronous_sequences.fasta">horses_isochronous_sequences.fasta</a></li>
        
          <li><a href="/tutorials/coalescent/scripts/mcmc_isochronous_Skyline.Rev">mcmc_isochronous_Skyline.Rev</a></li>
        
        </ul>
    
</blockquote>


</div>
<h2 class="section" id="skyline-plots">Skyline Plots</h2>
<hr class="section" />

<p>Skyline Plots are models for how population size changes through time.
The classical skyline plot <a class="citation" href="#Pybus2000">(Pybus et al. 2000)</a> provided the first implementation of this idea.
For each interval between two coalescent events, an effective population size was estimated.
This led to a plot looking very similar to a skyline, thus giving the method its name (see <a href="#classical-skyline"></a> for a hypothetical example).
The generalized skyline plot <a class="citation" href="#Strimmer2001">(Strimmer and Pybus 2001)</a> aimed at reducing the noise from analyzing every single interval by grouping several coalescent events into one interval.
This created a smoother curve.
First, these models were used for maximum likelihood (ML) estimation of population sizes through time.
By now, several extensions allowing for Bayesian estimation have been published (see for example <a class="citation" href="#Drummond2005">Drummond et al. (2005), Heled and Drummond (2008), Minin et al. (2008)</a>).
In <code class="language-plaintext highlighter-rouge">RevBayes</code>, a Skyline plot method is implemented with constant or linear population size intervals.
<!--- In other software, you can also find the possibility to have linear skyline intervals. --->
<!--- Even though this is not implemented explicitly as skyline in `RevBayes`, you can also piece together linear intervals (have a look at the [piecewise model exercise](/tutorials/coalescent/piecewise), if you are interested in this). --->
<!--- The length of these intervals is not based on the timing of the coalescent events, but can be individually chosen. --->
The length of the skyline intervals can either be defined by a specific number of intervals ending at coalescent events, or alternatively be chosen individually without depending on the coalescent events.
<!--- In this tutorial, each interval will have the same length. --->
In this exercise, each interval will group five coalescent events.
Have a look at <a href="#event-skyline"></a>, for a hypothetical example with three events per interval.</p>

<figure id="classical-skyline"><p><img src="figures/scheme_classical_skyline.png" /></p>
<figcaption>Hypothetical example of a classical skyline plot. $w_k$ are the waiting times with $k$ active lineages, $t_{c,k}$ are the coalescent events at the beginning of such a coalescent interval. Here, a population size for each interval between coalescent events is calculated. The bold line represents the maximum likelihood estimate of the population size.</figcaption>
</figure>

<figure id="event-skyline"><p><img src="figures/scheme_event_skyline.png" /></p>
<figcaption>Hypothetical example of a Bayesian skyline plot with the interval length dependent on the number of coalescent events (coalescent event based).  $w_k$ are the waiting times with $k$ active lineages, $t_{c,k}$ are the coalescent events at the beginning of such a coalescent interval. $t_{i,j}$ mark the points of interval change.  Here, the change-points are coalescent event based, <em>i.e.</em>, dependent on coalescent events. The bold line represents the median of the posterior distribution of the population size and the shaded are shows the $95\%$ credible intervals.</figcaption>
</figure>

<blockquote class="aside"><h2>Likelihood Calculation</h2><p>We assume that the phylogeny of the samples is known.
There are $n$ samples, with $k$ active lineages at the current point in time $t$.
Time starts at $t = 0$.
The waiting times between coalescent events $w_k$ are exponentially distributed with rate $c = \frac{k (k-1)}{2N_e(t)}$ with $N_e$ being the population size.
<!--- In the case of a skyline plot, the population size curve is split into $m$ intervals which each have a starting point $t_i$. ---></p>

<p>The likelihood for a given piecewise-constant population size trajectory is computed as the product of the probability density functions of the coalescent waiting times, which are calculated as follows:</p>

\[p(w_k | t_{c,k}) = \frac{k (k -1)}{2N_e(t_{c,k} + w_k)} exp \left[ \int_{t_{c,k}}^{t_{c,k}+w_k} \frac{k (k -1)}{2N_e(t)} dt \right]\]

<p>Each $t_{c,k}$ is the beginning of the respective kth coalescent interval.
The waiting times $w_k$ refer to the waiting time starting when there are $k$ active lineages.</p>

<!--- In our case, $N_e(t)$ is a piecewise constant demographic function with $m$ intervals which each have a starting point $t_i$ and the length $l$.
**Do I need to go into the intervals here?** --->
</blockquote>

<h2 class="section" id="inference-example">Inference Example</h2>
<hr class="section" />

<blockquote class="info">
  <h2 id="for-your-info">For your info</h2>
  <p>The entire process of the skyline estimation can be executed by using the <strong>mcmc_isochronous_Skyline.Rev</strong> script that you can download on the left side of the page.
Save it in your <strong>scripts</strong> directory.
You can type the following command into <code class="language-plaintext highlighter-rouge">RevBayes</code>:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source("scripts/mcmc_isochronous_Skyline.Rev")
</code></pre></div>  </div>
  <p>We will walk you through the script in the following section.</p>
</blockquote>

<p>We will mainly highlight the parts of the script that change compared to the <a href="/tutorials/coalescent/Constant">constant coalescent model</a>.</p>

<h3 class="subsection" id="read-the-data">Read the data</h3>
<hr class="subsection" />

<p>Read in the data as described in the first exercise.</p>

<h3 class="subsection" id="the-skyline-model">The Skyline Model</h3>
<hr class="subsection" />

<p>For the skyline model, you need to decide on the number of intervals.
In this case, we would like to have five coalescent events per interval, so we divide the number of coalescent events by five.
With $n$ taxa, we expect $(n-1)$ coalescent events, until there is only one lineage left.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NUM_INTERVALS = ceil((n_taxa - 1) / 5)
</code></pre></div></div>

<p>For each interval, a population size will be estimated.
Choose a prior and add a move for each population size.
In the following loop, we also set the number of coalescent events per interval by dividing the number of coalescent events by the number of intervals.
Remember that we chose the number of intervals based on our wish to have $5$ events per interval.</p>

<!---
<blockquote class="aside"><h2>Number of coalescent events per interval</h2><p>In this particular example, there are $36$ taxa, resulting in $35$ coalescent events, so there is no remainder when dividing by $5$.
If there is a remainder</p>
</blockquote>
--->

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (i in 1:NUM_INTERVALS) {

    pop_size[i] ~ dnUniform(0,1E6)
    pop_size[i].setValue(100000)
    moves.append( mvScale(pop_size[i], lambda=0.1, tune=true, weight=2.0) )
    num_events[i] &lt;- ceil( (n_taxa-1) / NUM_INTERVALS )

}
</code></pre></div></div>

<h3 class="subsection" id="the-tree">The Tree</h3>
<hr class="subsection" />

<p>Now, we will instantiate the stochastic node for the tree.
The Skyline version of the Coalescent distribution function <code class="language-plaintext highlighter-rouge">dnCoalescentSkyline</code> takes the vector of population sizes and the taxa as input. <!--- **(need to check whether it can take more)** --->
By chosing <code class="language-plaintext highlighter-rouge">methods="events"</code>, the interval lengths will be chosen based on the number of events and we have to add the number of coalescent events to the input.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psi ~ dnCoalescentSkyline(theta=pop_size, events_per_interval=num_events, method="events", taxa=taxa)
</code></pre></div></div>

<p>For later plotting and analyzing the population size curve, we need to retrieve the resulting interval times.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interval_times := psi.getIntervalAges()
</code></pre></div></div>

<p>For this analysis, we constrain the root age as before and add the same moves for the tree.</p>

<h3 class="subsection" id="substitution-model-and-other-parameters">Substitution Model and other parameters</h3>
<hr class="subsection" />

<p>This part is also taken from the <a href="/tutorials/coalescent/Constant">constant coalescent exercise</a>.</p>

<h3 class="subsection" id="finalize-and-run-the-analysis">Finalize and run the analysis</h3>
<hr class="subsection" />

<p>Finally, we need to wrap our model as before.
We add the monitors and then run the MCMC.
Here, an additional monitor is added for the interval times.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors.append( mnModel(filename="output/horses_iso_Skyline.log",printgen=THINNING) )
monitors.append( mnFile(filename="output/horses_iso_Skyline.trees",psi,printgen=THINNING) )
monitors.append( mnFile(filename="output/horses_iso_Skyline_NEs.log",pop_size,printgen=THINNING) )
monitors.append( mnFile(filename="output/horses_iso_Skyline_times.log",interval_times,printgen=THINNING) )
monitors.append( mnScreen(pop_size, root_age, printgen=100) )
</code></pre></div></div>

<h2 class="section" id="results">Results</h2>
<hr class="section" />

<p>After running your analysis, you can plot the results again using the <code class="language-plaintext highlighter-rouge">R</code> package <code class="language-plaintext highlighter-rouge">RevGadgets</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>library(RevGadgets)

burnin = 0.1
probs = c(0.025, 0.975)
summary = "median"

num_grid_points = 500
max_age_iso = 5e5
min_age = 0
spacing = "equal"

population_size_log = "output/horses_iso_Skyline_NEs.log"
interval_change_points_log = "output/horses_iso_Skyline_times.log"
df &lt;- processPopSizes(population_size_log, interval_change_points_log, burnin = burnin, probs = probs, summary = summary, num_grid_points = num_grid_points, max_age = max_age_iso, min_age = min_age, spacing = spacing)
p &lt;- plotPopSizes(df) + ggplot2::coord_cartesian(ylim = c(1e3, 1e8))
ggplot2::ggsave("figures/horses_iso_Skyline.png", p)
</code></pre></div></div>

<figure id="results-skyline"><p><img src="figures/horses_iso_Skyline.png" width="800" /></p>
<figcaption>Example output from plotting the coalescent Skyline analysis run in this exercise. The bold line represents the median of the posterior distribution of the population size and the shaded are shows the $95\%$ credible intervals.</figcaption>
</figure>

<h2 class="section" id="next-exercise">Next Exercise</h2>
<hr class="section" />

<p>When you are done, have a look at the next exercise.</p>

<ul>
  <li><a href="/tutorials/coalescent/GMRF">The Gaussian Markov Random Field (GMRF) model</a></li>
</ul>

<h2 class="section" id="secAltPriors">Alternative Priors</h2>
<hr class="section" />

<p>There are many different ways of defining priors for the population sizes.
Here, we chose to draw the population sizes from a Uniform distribution and to treat the intervals as independent and identically distributed (iid).
In other software, the default priors can be defined differently.</p>

<p>For example, for the Bayesian Skyline Plot <a class="citation" href="#Drummond2005">(Drummond et al. 2005)</a>, all but the first population size are drawn from an exponential distribution.
The mean of this distribution is set to be the previous population size.
This means that the population sizes in neighbouring intervals are correlated.
For the first population size, a log uniform distribution was chosen.
Additionally, the number of coalescent events per interval is not fixed, but estimated during the MCMC.</p>

<p>In a Skyride analysis <a class="citation" href="#Minin2008">(Minin et al. 2008)</a>, the population size is directly estimated on a log scale.
The intervals also are correlated, but a Gaussian Markov Random Field (GMRF) prior is used with the degree of smoothing being regulated by a precision parameter.
In this approach, each interval includes one coalescent event, similar to the classical Skyline plot.
The smoothing effect, however, reduces the noise in the resulting population size trajectory.</p>

<p>For the Extended Bayesian Skyline Plot <a class="citation" href="#Heled2008">(Heled and Drummond 2008)</a>, the number of change-points is estimated by stochastic search variable selection.
The intervals are considered to be iid.
Also, the default demographic function usually is piecewise linear and not piecewise constant as in this tutorial.
The estimation of the number of intervals can also be done slightly differently, as we show in the <a href="/tutorials/coalescent/Skyfish">Skyfish tutorial</a>.</p>

<p>You can try and change the priors now accordingly.
If you would like to have an example of what a <code class="language-plaintext highlighter-rouge">RevBayes</code> script with these different priors can look like, have a look at</p>
<ul>
  <li>the <a href="scripts/mcmc_isochronous_BSP.Rev">example script for a BSP analysis</a>,</li>
  <li>the <a href="scripts/mcmc_isochronous_Skyride.Rev">example script for a Skyride analysis</a>, or</li>
  <li>the <a href="scripts/mcmc_isochronous_EBSP.Rev">example script for an EBSP analysis</a>. Note that the <code class="language-plaintext highlighter-rouge">.Rev</code> script does not apply stochastic variable search as in the original publication to determine the number of interval change-points. The script instead uses reversible jump MCMC.</li>
</ul>

<p>All three examples have the interval change-points on coalescent events (what we call âcoalescent event basedâ, as in the skyline model presented here).
In the next tutorial (<a href="/tutorials/coalescent/GMRF">The GMRF model</a>), we use intervals with changing points independent from coalescent events (âspecifiedâ).</p>

<ol class="bibliography"><li><span id="Drummond2005">Drummond A.J., Rambaut A., Shapiro B., Pybus O.G. 2005. Bayesian Coalescent Inference of Past Population Dynamics from Molecular Sequences. Molecular Biology and Evolution. 22:1185â1192.</span>

<a href="https://doi.org/10.1093/molbev/msi103">10.1093/molbev/msi103</a>

</li>
<li><span id="Heled2008">Heled J., Drummond A.J. 2008. Bayesian inference of population size history from multiple loci. BMC Evolutionary Biology. 8:289.</span>

<a href="https://doi.org/10.1186/1471-2148-8-289">10.1186/1471-2148-8-289</a>

</li>
<li><span id="Minin2008">Minin V.N., Bloomquist E.W., Suchard M.A. 2008. Smooth Skyride through a Rough Skyline: Bayesian Coalescent-Based Inference of Population Dynamics. Molecular Biology and Evolution. 25:1459â1471.</span>

<a href="https://doi.org/10.1093/molbev/msn090">10.1093/molbev/msn090</a>

</li>
<li><span id="Pybus2000">Pybus O.G., Rambaut A., Harvey P.H. 2000. An Integrated Framework for the Inference of Viral Population History From Reconstructed Genealogies. Genetics. 155:1429â1437.</span>

<a href="https://doi.org/10.1093/genetics/155.3.1429">10.1093/genetics/155.3.1429</a>

</li>
<li><span id="Strimmer2001">Strimmer K., Pybus O.G. 2001. Exploring the Demographic History of DNA Sequences Using the Generalized Skyline Plot. Molecular Biology and Evolution. 18:2298â2305.</span>

<a href="https://doi.org/10.1093/oxfordjournals.molbev.a003776">10.1093/oxfordjournals.molbev.a003776</a>

</li></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2 class='references'>References</h2><hr class='references'>"+elem_ol.outerHTML
	}
}
</script>

      </div>
      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/license">License</a> | <a href="/citation">Citation</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/assets/js/vendor/jquery.min.js"></script>
<script src="/assets/js/vendor/FileSaver.min.js"></script>
<script src="/assets/js/vendor/jszip.min.js"></script>
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
    });
    MathJax.Hub.Queue(function () {
      $(".aside").each(function() {
          $("div .MathJax", this).hide();
      });
    });
</script>
<script src="/assets/js/base.js"></script>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0Y03X9Q2TJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0Y03X9Q2TJ');
</script>

  </body>
</html>
